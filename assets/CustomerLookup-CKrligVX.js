import{j as e}from"./index-D0cJwDsb.js";import{r as o}from"./vendor-DD54NZMZ.js";import{c as N,e as f,r as B}from"./relativeTime-CBzUSEMY.js";import{F as c,T as U,f as $,u as b,v as O,w as X,I as q,B as x,x as G,S as J,A as Q,y as C,z as l,E as V,M as T,H as E,l as W,J as _,K as Z,N as ee,O as te,P as ne,Q as se}from"./antd-pmzi8FkM.js";import"./utils-Db1EesZb.js";l.extend(B);l.locale("vi");const{Title:M,Text:a,Paragraph:v}=U,{TabPane:m}=b,ce=()=>{const[h]=c.useForm(),[u,p]=o.useState(!1),[g,k]=o.useState(null),[i,y]=o.useState(null),[P,I]=o.useState("products"),[w,d]=o.useState(!1),[z,S]=o.useState(!1),[R,K]=o.useState(""),F=t=>{if(!t)return{status:"unknown",text:"Không xác định"};const n=l(),s=l(t).diff(n,"day");return s<0?{status:"expired",text:"Hết hạn",daysText:`Hết hạn ${Math.abs(s)} ngày trước`}:s<=30?{status:"expiring",text:"Sắp hết hạn",daysText:`Còn ${s} ngày`}:{status:"active",text:"Còn hiệu lực",daysText:`Còn ${s} ngày`}},L=async t=>{p(!0),k(null),y(null);try{const n=`customer_lookup_${t.searchType}_${t.searchValue}`,r=await N.get(n);if(r){y(r),p(!1);return}const s=await f.get("/customer/lookup",{params:{type:t.searchType,value:t.searchValue}});N.set(n,s,300),y(s)}catch(n){console.error("Error looking up customer information:",n),k(n.message||"Không thể tìm thấy thông tin. Vui lòng kiểm tra lại số điện thoại hoặc mã đơn hàng.")}finally{p(!1)}},Y=async t=>{d(!0);try{await f.download(`/customer/invoice/${t}`,{},`hoa-don-${t}.pdf`)}catch(n){console.error("Error downloading invoice:",n),T.error({title:"Không thể tải hóa đơn",content:"Đã xảy ra lỗi khi tải hóa đơn. Vui lòng thử lại sau."})}finally{d(!1)}},A=async t=>{d(!0);try{const n=await f.get(`/customer/invoice/${t}/preview`,{responseType:"blob"}),r=URL.createObjectURL(n);K(r),S(!0)}catch(n){console.error("Error previewing invoice:",n),T.error({title:"Không thể xem hóa đơn",content:"Đã xảy ra lỗi khi tải hóa đơn. Vui lòng thử lại sau."})}finally{d(!1)}},D=[{title:"Sản phẩm",dataIndex:"name",key:"name",render:(t,n)=>e.jsxs("div",{children:[e.jsx(a,{strong:!0,children:t}),e.jsx("div",{children:e.jsxs(a,{type:"secondary",style:{fontSize:"12px"},children:["Mã SN: ",n.serial_number]})})]})},{title:"Ngày mua",dataIndex:"purchase_date",key:"purchase_date",render:t=>l(t).format("DD/MM/YYYY")},{title:"Bảo hành",dataIndex:"warranty_expiry",key:"warranty",render:(t,n)=>{const r=F(t);let s="green",j=e.jsx(te,{});return r.status==="expired"?(s="red",j=e.jsx(ne,{})):r.status==="expiring"&&(s="orange",j=e.jsx(se,{})),e.jsxs("div",{children:[e.jsx(E,{color:s,icon:j,children:r.text}),e.jsx("div",{style:{marginTop:"4px"},children:e.jsx(a,{type:"secondary",style:{fontSize:"12px"},children:r.daysText})})]})}},{title:"Đơn hàng",dataIndex:"order_id",key:"order",render:t=>e.jsxs(x,{type:"link",size:"small",onClick:()=>I("orders"),children:["#",t]})}],H=[{title:"Mã đơn",dataIndex:"id",key:"id",render:t=>e.jsxs(a,{strong:!0,children:["#",t]})},{title:"Ngày mua",dataIndex:"created_at",key:"created_at",render:t=>l(t).format("DD/MM/YYYY")},{title:"Tổng tiền",dataIndex:"total",key:"total",render:t=>new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(t)},{title:"Trạng thái",dataIndex:"status",key:"status",render:t=>{let n="blue";return t==="completed"&&(n="green"),t==="cancelled"&&(n="red"),e.jsx(E,{color:n,children:t==="completed"?"Hoàn thành":t==="cancelled"?"Đã hủy":"Đang xử lý"})}},{title:"Hóa đơn",key:"actions",render:(t,n)=>e.jsxs(W,{size:"small",children:[e.jsx(_,{title:"Xem hóa đơn",children:e.jsx(x,{type:"text",icon:e.jsx(Z,{}),onClick:()=>A(n.id),loading:w})}),e.jsx(_,{title:"Tải hóa đơn",children:e.jsx(x,{type:"text",icon:e.jsx(ee,{}),onClick:()=>Y(n.id),loading:w})})]})}];return e.jsxs("div",{children:[e.jsx(M,{level:2,className:"text-center mb-6",children:"Tra cứu sản phẩm & bảo hành"}),e.jsx($,{className:"mb-6",children:e.jsxs(c,{form:h,layout:"vertical",onFinish:L,initialValues:{searchType:"phone"},children:[e.jsx(c.Item,{name:"searchType",label:"Tìm kiếm theo",children:e.jsxs(b,{onChange:t=>h.setFieldsValue({searchType:t}),children:[e.jsx(m,{tab:e.jsxs("span",{children:[e.jsx(O,{})," Số điện thoại"]})},"phone"),e.jsx(m,{tab:e.jsxs("span",{children:[e.jsx(X,{})," Mã đơn hàng"]})},"order")]})}),e.jsx(c.Item,{name:"searchValue",label:"Nhập thông tin tìm kiếm",rules:[{required:!0,message:"Vui lòng nhập thông tin tìm kiếm"},{validator:(t,n)=>{const r=h.getFieldValue("searchType");if(r==="phone"&&n){if(!/^(0|\+84)[3|5|7|8|9][0-9]{8}$/.test(n))return Promise.reject("Số điện thoại không hợp lệ")}else if(r==="order"&&n&&!/^[a-zA-Z0-9-]{3,20}$/.test(n))return Promise.reject("Mã đơn hàng không hợp lệ");return Promise.resolve()}}],children:e.jsx(q,{placeholder:h.getFieldValue("searchType")==="phone"?"Nhập số điện thoại":"Nhập mã đơn hàng",size:"large",allowClear:!0})}),e.jsx(c.Item,{children:e.jsx(x,{type:"primary",htmlType:"submit",icon:e.jsx(G,{}),loading:u,size:"large",block:!0,children:"Tra cứu"})})]})}),u&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(J,{size:"large"}),e.jsx("div",{className:"mt-4",children:e.jsx(a,{type:"secondary",children:"Đang tìm kiếm thông tin..."})})]}),g&&e.jsx(Q,{message:"Không tìm thấy thông tin",description:g,type:"error",showIcon:!0,className:"mb-6"}),i&&e.jsxs("div",{children:[e.jsx($,{className:"mb-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center",children:[e.jsxs("div",{children:[e.jsx(M,{level:4,children:"Thông tin khách hàng"}),e.jsxs(v,{children:[e.jsx(a,{strong:!0,children:"Họ tên:"})," ",i.customer.name]}),e.jsxs(v,{children:[e.jsx(a,{strong:!0,children:"Số điện thoại:"})," ",i.customer.phone]}),i.customer.email&&e.jsxs(v,{children:[e.jsx(a,{strong:!0,children:"Email:"})," ",i.customer.email]})]}),e.jsxs("div",{className:"mt-4 sm:mt-0",children:[e.jsx(a,{type:"secondary",children:"Tổng sản phẩm đã mua: "}),e.jsx(a,{strong:!0,children:i.products.length}),e.jsx("br",{}),e.jsx(a,{type:"secondary",children:"Tổng đơn hàng: "}),e.jsx(a,{strong:!0,children:i.orders.length})]})]})}),e.jsxs(b,{activeKey:P,onChange:I,children:[e.jsx(m,{tab:"Sản phẩm & Bảo hành",children:e.jsx(C,{columns:D,dataSource:i.products.map(t=>({...t,key:t.id})),pagination:{pageSize:5},locale:{emptyText:"Không có sản phẩm nào"}})},"products"),e.jsx(m,{tab:"Đơn hàng",children:e.jsx(C,{columns:H,dataSource:i.orders.map(t=>({...t,key:t.id})),pagination:{pageSize:5},locale:{emptyText:"Không có đơn hàng nào"}})},"orders")]})]}),!u&&!g&&!i&&e.jsx(V,{image:V.PRESENTED_IMAGE_SIMPLE,description:"Nhập thông tin để tra cứu sản phẩm và bảo hành"}),e.jsx(T,{visible:z,title:"Xem hóa đơn",footer:null,onCancel:()=>{S(!1),URL.revokeObjectURL(R)},width:800,children:e.jsx("iframe",{src:R,style:{width:"100%",height:"70vh"},title:"Invoice Preview"})})]})};export{ce as default};
