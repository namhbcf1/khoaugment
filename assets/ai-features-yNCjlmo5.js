import{r as e,j as t}from"./react-vendor-BmR3b86j.js";import{a as n}from"./http-ztdpVPaQ.js";import{s as a}from"./admin-pages-T52mFZfb.js";import{d as s}from"./datetime-nPpyZAU3.js";import{k as r,x as i,T as o,R as c,a as l,C as d,S as h,B as u,F as m,j as g,A as p,v as y,L as f,e as x,P as v,f as j,D as w,p as S,d as M,b,q as k,N as C,l as I,g as P,I as z}from"./antd-core-DmtdYCMe.js";import{aw as D,a as T,v as R,al as _,V as E,l as A,f as O,q as N,u as $,e as L,n as B,g as V,h as q,j as F,af as K,o as U,m as Y,ah as J,aH as G,aI as H}from"./antd-icons-CM8WQBCd.js";import{R as W,P as Q,e as X,f as Z,c as ee,a as te,X as ne,Y as ae,B as se,C as re,T as ie,L as oe,b as ce,A as le,S as de,g as he}from"./charts-B2tExK65.js";const ue={},me=function(e,t,n){let a=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const e=document.querySelector("meta[property=csp-nonce]"),n=e?.nonce||e?.getAttribute("nonce");a=Promise.allSettled(t.map(e=>{if((e=function(e){return"/"+e}(e))in ue)return;ue[e]=!0;const t=e.endsWith(".css"),a=t?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${e}"]${a}`))return;const s=document.createElement("link");return s.rel=t?"stylesheet":"modulepreload",t||(s.as="script"),s.crossOrigin="",s.href=e,n&&s.setAttribute("nonce",n),document.head.appendChild(s),t?new Promise((t,n)=>{s.addEventListener("load",t),s.addEventListener("error",()=>n(new Error(`Unable to preload CSS for ${e}`)))}):void 0}))}function s(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return a.then(t=>{for(const e of t||[])"rejected"===e.status&&s(e.reason);return e().catch(s)})},ge="auth_token",pe="refresh_token",ye="user_info",fe="token_expiry",xe=()=>{const e=localStorage.getItem("session_id");e&&a.destroySession(e),localStorage.removeItem(ge),localStorage.removeItem(pe),localStorage.removeItem(ye),localStorage.removeItem(fe),localStorage.removeItem("session_id"),a.logSecurityEvent("logout")},ve=async()=>{const e=localStorage.getItem(pe);if(!e)return null;try{const{apiClient:t}=await me(async()=>{const{apiClient:e}=await Promise.resolve().then(()=>Ke);return{apiClient:e}},void 0),n=await t.post("/auth/refresh",{refreshToken:e},{headers:{"X-Skip-Auth":"true"}});return n.data&&n.data.accessToken?(((e,t,n=3600,s=null)=>{const r=a.encrypt(e),i=a.encrypt(t);localStorage.setItem(ge,JSON.stringify(r)),localStorage.setItem(pe,JSON.stringify(i));const o=Date.now()+1e3*n;if(localStorage.setItem(fe,o.toString()),s){const e=a.createSession(s.id,s);localStorage.setItem("session_id",e),a.logSecurityEvent("successful_login",{userId:s.id,role:s.role})}})(n.data.accessToken,n.data.refreshToken||e,n.data.expiresIn||3600),n.data.user&&je(n.data.user),n.data.accessToken):null}catch(t){return xe(),null}},je=e=>{localStorage.setItem(ye,JSON.stringify(e))};const we=new class{constructor(){this.cache=new Map,this.ttls=new Map,this.cleanupInterval=setInterval(()=>this.cleanup(),6e4)}set(e,t,n=0){if(this.cache.set(e,t),n>0){const t=Date.now()+1e3*n;this.ttls.set(e,t)}else this.ttls.delete(e)}get(e){if(!this.isExpired(e))return this.cache.get(e);this.delete(e)}delete(e){this.cache.delete(e),this.ttls.delete(e)}clear(){this.cache.clear(),this.ttls.clear()}has(e){return!!this.cache.has(e)&&(!this.isExpired(e)||(this.delete(e),!1))}isExpired(e){const t=this.ttls.get(e);return!!t&&Date.now()>t}cleanup(){for(const[e,t]of this.ttls.entries())Date.now()>t&&this.delete(e)}keys(){return Array.from(this.cache.keys()).filter(e=>!this.isExpired(e))}destroy(){clearInterval(this.cleanupInterval),this.clear()}};const Se=new class{constructor(e="posAppCache",t="cache",n=1){this.dbName=e,this.storeName=t,this.version=n,this.db=null,this.isInitialized=!1,this.init()}async init(){if(window.indexedDB)try{const e=indexedDB.open(this.dbName,this.version);e.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains(this.storeName)){t.createObjectStore(this.storeName,{keyPath:"key"}).createIndex("expiry","expiry",{unique:!1})}},this.db=await new Promise((t,n)=>{e.onsuccess=e=>{t(e.target.result)},e.onerror=e=>{n(e.target.error)}}),this.isInitialized=!0,this.scheduleCleanup()}catch(e){}}async ensureInitialized(){return this.isInitialized||await new Promise(e=>{const t=()=>{this.isInitialized?e():setTimeout(t,100)};t()}),this.db}async set(e,t,n=0){try{const a=await this.ensureInitialized();if(!a)return;const s=n>0?Date.now()+1e3*n:0,r=a.transaction([this.storeName],"readwrite"),i=r.objectStore(this.storeName);await new Promise((n,a)=>{const o=i.put({key:e,value:t,expiry:s,created:Date.now()});o.onsuccess=()=>n(),o.onerror=e=>a(e.target.error),r.oncomplete=()=>n(),r.onerror=e=>a(e.target.error)})}catch(a){}}async get(e){try{const t=await this.ensureInitialized();if(!t)return;const n=t.transaction([this.storeName],"readonly").objectStore(this.storeName);return await new Promise((t,a)=>{const s=n.get(e);s.onsuccess=n=>{const a=n.target.result;a?a.expiry>0&&Date.now()>a.expiry?(this.delete(e).catch(console.error),t(void 0)):t(a.value):t(void 0)},s.onerror=e=>{a(e.target.error)}})}catch(t){return}}async delete(e){try{const t=await this.ensureInitialized();if(!t)return;const n=t.transaction([this.storeName],"readwrite").objectStore(this.storeName);await new Promise((t,a)=>{const s=n.delete(e);s.onsuccess=()=>t(),s.onerror=e=>a(e.target.error)})}catch(t){}}async clear(){try{const e=await this.ensureInitialized();if(!e)return;const t=e.transaction([this.storeName],"readwrite").objectStore(this.storeName);await new Promise((e,n)=>{const a=t.clear();a.onsuccess=()=>e(),a.onerror=e=>n(e.target.error)})}catch(e){}}async has(e){try{return void 0!==await this.get(e)}catch(t){return!1}}async keys(){try{const e=await this.ensureInitialized();if(!e)return[];const t=e.transaction([this.storeName],"readonly").objectStore(this.storeName);return new Promise((e,n)=>{const a=t.getAllKeys();a.onsuccess=()=>e(a.result),a.onerror=e=>n(e.target.error)})}catch(e){return[]}}scheduleCleanup(){setInterval(()=>this.cleanup(),36e5)}async cleanup(){try{const e=await this.ensureInitialized();if(!e)return;const t=Date.now(),n=e.transaction([this.storeName],"readwrite"),a=n.objectStore(this.storeName).index("expiry"),s=IDBKeyRange.bound(1,t);await new Promise((e,t)=>{const n=a.openCursor(s);n.onsuccess=t=>{const n=t.target.result;n?(n.delete(),n.continue()):e()},n.onerror=e=>t(e.target.error)})}catch(e){}}},Me={set:(e,t,n=0,a=!0)=>{we.set(e,t,n),a&&Se.set(e,t,n).catch(console.error)},get:async e=>{const t=we.get(e);if(void 0!==t)return t;const n=await Se.get(e);return void 0!==n&&we.set(e,n,0),n},delete:e=>{we.delete(e),Se.delete(e).catch(console.error)},clear:()=>{we.clear(),Se.clear().catch(console.error)},has:async e=>!!we.has(e)||await Se.has(e)},be={enabled:!0,consoleLog:!1,endpointUrl:"/api/analytics",bufferSize:10,flushInterval:3e4,samplingRate:1,includePerformance:!0,anonymizeIp:!0,offlineStorage:!0,appVersion:"1.0.0"};let ke={...be},Ce=[],Ie={},Pe=!1,ze=Ae(),De=0;const Te=(e={})=>{Pe||(ke={...be,...e},function(){const e=sessionStorage.getItem("analytics_session_id"),t=parseInt(sessionStorage.getItem("analytics_session_timestamp")||"0"),n=Date.now();e&&n-t<18e5?ze=e:(ze=Ae(),sessionStorage.setItem("analytics_session_id",ze));sessionStorage.setItem("analytics_session_timestamp",n.toString())}(),ke.flushInterval>0&&setInterval(()=>Ee(),ke.flushInterval),ke.includePerformance&&function(){try{const t=performance.getEntriesByType("navigation")[0],n=performance.getEntriesByType("paint");t&&(Ie.loadTime=t.loadEventEnd-t.startTime,Ie.domContentLoaded=t.domContentLoadedEventEnd-t.startTime,Ie.timeToFirstByte=t.responseStart-t.requestStart,Ie.domInteractive=t.domInteractive-t.startTime);const a=n.find(e=>"first-paint"===e.name);a&&(Ie.firstPaint=a.startTime);const s=n.find(e=>"first-contentful-paint"===e.name);if(s&&(Ie.firstContentfulPaint=s.startTime),performance.memory&&(Ie.jsHeapSizeLimit=performance.memory.jsHeapSizeLimit,Ie.totalJSHeapSize=performance.memory.totalJSHeapSize,Ie.usedJSHeapSize=performance.memory.usedJSHeapSize),Re("performance",Ie),"PerformanceObserver"in window)try{new PerformanceObserver(e=>{e.getEntries().forEach(e=>{e.duration>50&&Re("long_task",{duration:e.duration,name:e.name,startTime:e.startTime})})}).observe({entryTypes:["longtask"]})}catch(e){}}catch(e){}}(),document.addEventListener("visibilitychange",Oe),window.addEventListener("online",Ne),window.addEventListener("offline",$e),_e(),Pe=!0)},Re=(e,t={},n=!1)=>{if(!ke.enabled)return;if(Math.random()>ke.samplingRate)return;const a={eventName:e,eventData:t,timestamp:Date.now(),sessionId:ze,url:window.location.href,referrer:document.referrer||"",userAgent:navigator.userAgent,screenSize:`${window.innerWidth}x${window.innerHeight}`,appVersion:ke.appVersion};ke.includePerformance&&(a.performance={...Ie}),ke.consoleLog,n?async function(e){await Be([e])}(a):(Ce.push(a),Ce.length>=ke.bufferSize&&Ee())},_e=(e=null,t=null)=>{De++,Re("page_view",{path:e||window.location.pathname,title:t||document.title,viewNumber:De})},Ee=async()=>{if(!Ce.length)return!0;try{const e=[...Ce];return Ce=[],!navigator.onLine&&ke.offlineStorage?(Le(e),!1):(await Be(e),!0)}catch(e){return ke.offlineStorage?(Le(Ce),Ce=[],!1):(Ce=[...Ce,...events],!1)}};function Ae(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function Oe(e){if("hidden"===document.visibilityState){const e=Date.now()-Ie.pageVisibleTime;Re("visibility_change",{state:"hidden",visibleTime:e},!0),Ee()}else"visible"===document.visibilityState&&(Ie.pageVisibleTime=Date.now(),Re("visibility_change",{state:"visible"}))}function Ne(){!async function(){try{const e=JSON.parse(localStorage.getItem("offline_analytics_events")||"[]");if(0===e.length)return;localStorage.removeItem("offline_analytics_events"),await Be(e)}catch(e){}}(),Re("connectivity_change",{state:"online"})}function $e(){Re("connectivity_change",{state:"offline"},!0)}function Le(e){if(e.length)try{const t=JSON.parse(localStorage.getItem("offline_analytics_events")||"[]"),n=[...t,...e].slice(-100);localStorage.setItem("offline_analytics_events",JSON.stringify(n))}catch(t){}}async function Be(e){if(e.length&&ke.endpointUrl)try{if(navigator.sendBeacon){const t=new Blob([JSON.stringify({events:e})],{type:"application/json"});if(navigator.sendBeacon(ke.endpointUrl,t))return}await fetch(ke.endpointUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({events:e}),keepalive:!0})}catch(t){throw t}}"undefined"!=typeof window&&Te();const Ve=n.create({baseURL:"https://khochuan-pos-api.bangachieu2.workers.dev",timeout:15e3,headers:{"Content-Type":"application/json","X-Client":"Khochuan-POS-Frontend","X-Client-Version":"1.0.0","X-Company":"Truong-Phat-Computer"}});Ve.interceptors.request.use(async e=>{if(e.url&&(e.url.includes("/auth/login")||e.url.includes("/auth/refresh")))return e;const t=(()=>{try{const t=localStorage.getItem(ge);if(!t)return null;const n=JSON.parse(t),s=a.decrypt(n.encrypted,n.iv),r=localStorage.getItem("session_id");if(r)try{a.validateSession(r)}catch(e){return xe(),null}return s}catch(e){return xe(),null}})();return t&&(e.headers.Authorization=`Bearer ${t}`),e.metadata={startTime:Date.now()},e.headers["X-Offline-Operation"]=navigator.onLine?"false":"true",e},e=>Promise.reject(e)),Ve.interceptors.response.use(e=>{if(e.config.metadata){const t=Date.now()-e.config.metadata.startTime;e.duration=t,t>1e3&&Re("api_performance",{endpoint:e.config.url,duration:t,status:e.status})}return e},async e=>{const t=e.config;if(!e.response&&"Network Error"===e.message){await async function(t){if(!("serviceWorker"in navigator)||!navigator.serviceWorker.controller){const e=JSON.parse(localStorage.getItem("offlineApiQueue")||"[]");return e.push({url:t.url,method:t.method,data:t.data,headers:t.headers,timestamp:Date.now()}),void localStorage.setItem("offlineApiQueue",JSON.stringify(e))}try{await navigator.serviceWorker.ready,await navigator.serviceWorker.controller.postMessage({type:"ENQUEUE_REQUEST",payload:{url:t.url,method:t.method,data:t.data,headers:t.headers,timestamp:Date.now()}})}catch(e){}}(t);const n=await async function(t){const n=`api_cache_${t.url}_${JSON.stringify(t.params||{})}`,a=we.get(n);if(a)return a;if("serviceWorker"in navigator&&navigator.serviceWorker.controller)try{await navigator.serviceWorker.ready;const e=await new Promise(e=>{const n=new MessageChannel;n.port1.onmessage=t=>e(t.data),navigator.serviceWorker.controller.postMessage({type:"GET_CACHED_RESPONSE",payload:{url:t.url,params:t.params}},[n.port2])});if(e&&e.data)return e.data}catch(e){}return null}(t);return n?Promise.resolve({...n,isOfflineCache:!0}):Promise.reject({...e,isOfflineError:!0,message:"You are currently offline. This operation will sync when you're back online."})}if(e.response&&401===e.response.status&&!t._retry){t._retry=!0;try{const e=await ve();if(e)return t.headers.Authorization=`Bearer ${e}`,Ve(t)}catch(a){return xe(),window.location.href="/login?session_expired=true",Promise.reject(a)}}if(e.response&&429===e.response.status&&!t._rateLimit){const n=e.response.headers["retry-after"]?1e3*parseInt(e.response.headers["retry-after"]):1e3;return t._rateLimit=!0,await new Promise(e=>setTimeout(e,n)),Ve(t)}if(e.response&&e.response.status>=500&&!t._serverRetry)return t._serverRetry=!0,await new Promise(e=>setTimeout(e,1e3)),Ve(t);const n={status:e.response?e.response.status:0,message:e.response&&e.response.data.message||e.message,data:e.response?e.response.data:null,originalError:e};return Re("api_error",{endpoint:t.url,method:t.method,status:n.status,message:n.message}),Promise.reject(n)});const qe={get:async(e,t={})=>(await Ve.get(e,t)).data,post:async(e,t={},n={})=>(await Ve.post(e,t,n)).data,put:async(e,t={},n={})=>(await Ve.put(e,t,n)).data,patch:async(e,t={},n={})=>(await Ve.patch(e,t,n)).data,delete:async(e,t={})=>(await Ve.delete(e,t)).data,async getCached(e,t={},n=300){const a=`api_cache_${e}_${JSON.stringify(t.params||{})}`,s=we.get(a);if(s)return s;const r=await Ve.get(e,t);return we.set(a,r.data,n),r.data},async upload(e,t,n=null,a={}){const s={...a,headers:{...a.headers,"Content-Type":"multipart/form-data"}};n&&(s.onUploadProgress=e=>{const t=Math.round(100*e.loaded/e.total);n(t,e)});return(await Ve.post(e,t,s)).data},async download(e,t={},n=null,a=null){const s={params:t,responseType:"blob",headers:{Accept:"application/octet-stream"}};a&&(s.onDownloadProgress=e=>{const t=Math.round(100*e.loaded/e.total);a(t,e)});const r=await Ve.get(e,s);if(n){const e=new Blob([r.data]),t=window.URL.createObjectURL(e),a=document.createElement("a");a.href=t,a.download=n,document.body.appendChild(a),a.click(),a.remove(),window.URL.revokeObjectURL(t)}return r.data},batch:async e=>(await Promise.allSettled(e.map(e=>{const t=(e.method||"get").toLowerCase();return Ve[t](e.url,e.data,e.config)}))).map(e=>"fulfilled"===e.status?{success:!0,data:e.value.data}:{success:!1,error:{status:e.reason.response?.status,message:e.reason.response?.data?.message||e.reason.message}}),async healthCheck(){try{return 200===(await Ve.get("/health",{timeout:5e3})).status}catch(e){return!1}},getClient:()=>Ve};window.addEventListener("online",async()=>{const e=JSON.parse(localStorage.getItem("offlineApiQueue")||"[]");if(e.length>0){for(const n of e)try{await Ve({url:n.url,method:n.method,data:n.data,headers:n.headers})}catch(t){}localStorage.removeItem("offlineApiQueue")}}),window.addEventListener("offline",()=>{});const Fe={...qe,login:async(e,t)=>await qe.post("/auth/login",{email:e,password:t}),logout:async()=>await qe.post("/auth/logout"),getProfile:async()=>await qe.get("/auth/me"),getProducts:async(e={})=>await qe.get("/products",{params:e}),getProduct:async e=>await qe.get(`/products/${e}`),getOrders:async(e={})=>await qe.get("/orders",{params:e}),createOrder:async e=>await qe.post("/orders",e),getDashboardStats:async()=>await qe.get("/analytics/dashboard"),getCategories:async()=>await qe.get("/categories")},Ke=Object.freeze(Object.defineProperty({__proto__:null,api:Fe,apiClient:Ve,default:Fe},Symbol.toStringTag,{value:"Module"}));const Ue=new class{constructor(){this.models=new Map,this.trainingData=new Map,this.predictions=new Map,this.initializeModels()}initializeModels(){this.models.set("customerSegmentation",{type:"kmeans",features:["totalSpent","frequency","recency","avgOrderValue"],clusters:5,trained:!1}),this.models.set("salesForecasting",{type:"linearRegression",features:["date","seasonality","promotions","weather"],trained:!1}),this.models.set("productRecommendation",{type:"collaborativeFiltering",features:["userId","productId","rating","category"],trained:!1}),this.models.set("priceOptimization",{type:"elasticityModel",features:["price","demand","competition","cost"],trained:!1})}async segmentCustomers(e){try{const t=this.calculateRFMMetrics(e),n=this.normalizeData(t),a=this.kMeansClustering(n,5),s=this.labelCustomerSegments(a);return{segments:s,metrics:this.calculateSegmentMetrics(s),insights:this.generateSegmentInsights(s)}}catch(t){throw t}}calculateRFMMetrics(e){const t=new Date;return e.map(e=>{const n=e.orders||[],a=n.length>0?new Date(Math.max(...n.map(e=>new Date(e.date)))):new Date(0),s=Math.floor((t-a)/864e5),r=n.length,i=n.reduce((e,t)=>e+(t.total||0),0),o=r>0?i/r:0;return{customerId:e.id,customerName:e.name,recency:s,frequency:r,monetary:i,avgOrderValue:o,registrationDate:e.createdAt,lastActivity:e.lastActivity}})}normalizeData(e){const t=["recency","frequency","monetary","avgOrderValue"],n=[],a={};return t.forEach(t=>{const n=e.map(e=>e[t]);a[t]={min:Math.min(...n),max:Math.max(...n),mean:n.reduce((e,t)=>e+t,0)/n.length}}),e.forEach(e=>{const s={...e};t.forEach(t=>{const{min:n,max:r}=a[t];s[t]=r>n?(e[t]-n)/(r-n):0}),n.push(s)}),{data:n,stats:a}}kMeansClustering(e,t=5){const n=e.data,a=["recency","frequency","monetary","avgOrderValue"];let s=[];for(let c=0;c<t;c++){const e={};a.forEach(t=>{e[t]=Math.random()}),s.push(e)}let r=0;let i=!1;for(;!i&&r<100;){const e=Array(t).fill().map(()=>[]);n.forEach(t=>{let n=1/0,r=0;s.forEach((e,s)=>{const i=this.euclideanDistance(t,e,a);i<n&&(n=i,r=s)}),e[r].push({...t,cluster:r})});const o=[];e.forEach((e,t)=>{if(e.length>0){const t={};a.forEach(n=>{t[n]=e.reduce((e,t)=>e+t[n],0)/e.length}),o.push(t)}else o.push(s[t])}),i=this.centroidsConverged(s,o,a),s=o,r++}const o=Array(t).fill().map(()=>[]);return n.forEach(e=>{let t=1/0,n=0;s.forEach((s,r)=>{const i=this.euclideanDistance(e,s,a);i<t&&(t=i,n=r)}),o[n].push({...e,cluster:n})}),{clusters:o,centroids:s,iterations:r,converged:i}}euclideanDistance(e,t,n){return Math.sqrt(n.reduce((n,a)=>{const s=e[a]-t[a];return n+s*s},0))}centroidsConverged(e,t,n,a=.001){return e.every((e,s)=>{const r=t[s];return n.every(t=>Math.abs(e[t]-r[t])<a)})}labelCustomerSegments(e){const{clusters:t,centroids:n}=e,a=[{name:"Champions",description:"Khách hàng VIP - mua nhiều, thường xuyên, gần đây",color:"#52c41a",strategy:"Reward them. Can be early adopters for new products."},{name:"Loyal Customers",description:"Khách hàng trung thành - mua thường xuyên",color:"#1890ff",strategy:"Upsell higher value products. Ask for reviews."},{name:"Potential Loyalists",description:"Khách hàng tiềm năng - mua gần đây nhưng chưa thường xuyên",color:"#722ed1",strategy:"Offer membership or loyalty program. Keep them engaged."},{name:"At Risk",description:"Khách hàng có nguy cơ rời bỏ - đã lâu không mua",color:"#fa8c16",strategy:"Send personalized emails. Offer discounts."},{name:"Lost Customers",description:"Khách hàng đã mất - lâu không mua, ít tương tác",color:"#ff4d4f",strategy:"Revive interest with reach out campaign. Ignore otherwise."}];return t.map((e,t)=>({index:t,cluster:e,centroid:n[t],avgMonetary:e.length>0?e.reduce((e,t)=>e+t.monetary,0)/e.length:0})).sort((e,t)=>t.avgMonetary-e.avgMonetary).map((e,t)=>({...a[t],clusterId:e.index,customers:e.cluster,centroid:e.centroid,size:e.cluster.length,avgMonetary:e.avgMonetary}))}calculateSegmentMetrics(e){return e.map(e=>{const t=e.customers;if(0===t.length)return{...e,metrics:{}};const n=t.reduce((e,t)=>e+t.monetary,0),a=t.reduce((e,t)=>e+t.recency,0)/t.length,s=t.reduce((e,t)=>e+t.frequency,0)/t.length,r=t.reduce((e,t)=>e+t.avgOrderValue,0)/t.length;return{...e,metrics:{totalRevenue:n,avgRecency:Math.round(a),avgFrequency:Math.round(10*s)/10,avgOrderValue:Math.round(r),customerCount:t.length,revenuePercentage:0}}})}generateSegmentInsights(e){const t=e.reduce((e,t)=>e+t.size,0),n=e.reduce((e,t)=>e+(t.metrics?.totalRevenue||0),0);e.forEach(e=>{e.metrics&&(e.metrics.revenuePercentage=n>0?Math.round(e.metrics.totalRevenue/n*100):0)});const a=[{type:"overview",title:"Tổng quan phân khúc khách hàng",description:`Đã phân tích ${t} khách hàng thành ${e.length} nhóm chính`,value:t,trend:"stable"}],s=e.reduce((e,t)=>(t.metrics?.totalRevenue||0)>(e.metrics?.totalRevenue||0)?t:e);a.push({type:"top_segment",title:"Nhóm khách hàng có giá trị cao nhất",description:`${s.name} đóng góp ${s.metrics?.revenuePercentage||0}% doanh thu`,value:s.metrics?.totalRevenue||0,segment:s.name});const r=e.find(e=>e.name.includes("At Risk")||e.name.includes("Lost"));return r&&a.push({type:"at_risk",title:"Khách hàng có nguy cơ rời bỏ",description:`${r.size} khách hàng cần được chăm sóc đặc biệt`,value:r.size,urgency:"high"}),a}predictCustomerSegment(e,t){const n=this.calculateRFMMetrics([e])[0],a=["recency","frequency","monetary","avgOrderValue"];let s=1/0,r=null;return t.forEach(e=>{const t=this.euclideanDistance(n,e.centroid,a);t<s&&(s=t,r=e)}),{segment:r,confidence:Math.max(0,1-s/2),recommendations:this.getSegmentRecommendations(r)}}getSegmentRecommendations(e){return{Champions:["Offer exclusive products and early access","Ask for referrals and reviews","Provide VIP customer service"],"Loyal Customers":["Upsell premium products","Offer loyalty rewards","Send personalized offers"],"Potential Loyalists":["Offer membership programs","Send educational content","Provide excellent onboarding"],"At Risk":["Send win-back campaigns","Offer limited-time discounts","Gather feedback on issues"],"Lost Customers":["Send reactivation emails","Offer significant discounts","Survey for improvement areas"]}[e.name]||["Monitor customer behavior"]}exportSegmentationResults(e){const t={timestamp:(new Date).toISOString(),totalSegments:e.length,segments:e.map(e=>({name:e.name,description:e.description,customerCount:e.size,metrics:e.metrics,strategy:e.strategy,customers:e.customers.map(e=>({id:e.customerId,name:e.customerName,rfm:{recency:e.recency,frequency:e.frequency,monetary:e.monetary,avgOrderValue:e.avgOrderValue}}))}))};return JSON.stringify(t,null,2)}async forecastSales(e,t=30){try{const n=this.prepareSalesTimeSeriesData(e),a=this.decomposeTimeSeries(n),s=this.linearRegressionForecast(a,t);return{forecast:s,confidence:this.calculateConfidenceIntervals(s,n),trends:a.trend,seasonality:a.seasonal,accuracy:this.calculateForecastAccuracy(n),insights:this.generateForecastInsights(s,a)}}catch(n){throw n}}prepareSalesTimeSeriesData(e){const t=new Map;e.forEach(e=>{const n=new Date(e.date).toISOString().split("T")[0];t.has(n)||t.set(n,{date:n,revenue:0,orders:0,items:0});const a=t.get(n);a.revenue+=e.total||0,a.orders+=1,a.items+=e.items?.length||0});const n=Array.from(t.values()).sort((e,t)=>new Date(e.date)-new Date(t.date));return this.fillMissingDates(n).map((e,t)=>({...e,dayIndex:t,dayOfWeek:new Date(e.date).getDay(),dayOfMonth:new Date(e.date).getDate(),month:new Date(e.date).getMonth(),quarter:Math.floor(new Date(e.date).getMonth()/3)}))}fillMissingDates(e){if(0===e.length)return[];const t=[],n=new Date(e[0].date),a=new Date(e[e.length-1].date),s=new Map(e.map(e=>[e.date,e]));for(let r=new Date(n);r<=a;r.setDate(r.getDate()+1)){const e=r.toISOString().split("T")[0];s.has(e)?t.push(s.get(e)):t.push({date:e,revenue:0,orders:0,items:0})}return t}decomposeTimeSeries(e){const t=e.map(e=>e.revenue),n=t.length,a=Math.min(7,Math.floor(n/4)),s=this.calculateMovingAverage(t,a),r=this.calculateSeasonalComponent(e,s),i=t.map((e,t)=>e-(s[t]||0)-(r[t]||0));return{original:t,trend:s,seasonal:r,residual:i}}calculateMovingAverage(e,t){const n=[],a=Math.floor(t/2);for(let s=0;s<e.length;s++){const t=Math.max(0,s-a),r=Math.min(e.length,s+a+1),i=e.slice(t,r),o=i.reduce((e,t)=>e+t,0)/i.length;n.push(o)}return n}calculateSeasonalComponent(e,t){const n=new Array(e.length).fill(0),a=new Array(7).fill(0),s=new Array(7).fill(0);e.forEach((e,n)=>{const r=e.dayOfWeek,i=e.revenue-(t[n]||0);a[r]+=i,s[r]++});for(let r=0;r<7;r++)s[r]>0&&(a[r]/=s[r]);return e.forEach((e,t)=>{n[t]=a[e.dayOfWeek]}),n}linearRegressionForecast(e,t){const{trend:n,seasonal:a}=e,s=n.length,r=Array.from({length:s},(e,t)=>t),i=n,{slope:o,intercept:c}=this.linearRegression(r,i),l=[];for(let d=0;d<t;d++){const e=o*(s+d)+c,t=d%7,n=a.length>0?a.filter((e,n)=>n%7===t).reduce((e,t)=>e+t,0)/Math.max(1,Math.floor(a.length/7)):0,r=Math.max(0,e+n);l.push({date:this.addDays(new Date,d+1).toISOString().split("T")[0],predicted:r,trend:e,seasonal:n})}return l}linearRegression(e,t){const n=e.length,a=e.reduce((e,t)=>e+t,0),s=t.reduce((e,t)=>e+t,0),r=(n*e.reduce((e,n,a)=>e+n*t[a],0)-a*s)/(n*e.reduce((e,t)=>e+t*t,0)-a*a);return{slope:r,intercept:(s-r*a)/n}}calculateConfidenceIntervals(e,t){const n=t.map(e=>e.revenue),a=n.reduce((e,t)=>e+t,0)/n.length,s=n.reduce((e,t)=>e+Math.pow(t-a,2),0)/n.length,r=Math.sqrt(s);return e.map(e=>({...e,lowerBound:Math.max(0,e.predicted-1.96*r),upperBound:e.predicted+1.96*r,confidence:95}))}calculateForecastAccuracy(e){if(e.length<14)return{mape:0,rmse:0,mae:0};const t=e.slice(0,-7),n=e.slice(-7),a=t.slice(-7).reduce((e,t)=>e+t.revenue,0)/7;let s=0,r=0,i=0;return n.forEach(e=>{const t=a,n=Math.abs(e.revenue-t),o=e.revenue>0?n/e.revenue*100:0;s+=o,r+=Math.pow(n,2),i+=n}),{mape:s/n.length,rmse:Math.sqrt(r/n.length),mae:i/n.length}}generateForecastInsights(e,t){const n=[],a=t.trend.length>1?t.trend[t.trend.length-1]-t.trend[0]:0;a>0?n.push({type:"trend",title:"Xu hướng tăng trưởng tích cực",description:`Doanh thu có xu hướng tăng ${(a/t.trend[0]*100).toFixed(1)}%`,impact:"positive"}):a<0&&n.push({type:"trend",title:"Xu hướng giảm cần chú ý",description:`Doanh thu có xu hướng giảm ${Math.abs(a/t.trend[0]*100).toFixed(1)}%`,impact:"negative"});const s=e.reduce((e,t)=>e+t.predicted,0)/e.length,r=e.filter(e=>e.predicted>1.1*s);return r.length>0&&n.push({type:"seasonality",title:"Ngày cao điểm dự kiến",description:`${r.length} ngày trong dự báo có doanh thu cao hơn trung bình`,impact:"opportunity"}),n}addDays(e,t){const n=new Date(e);return n.setDate(n.getDate()+t),n}async generateProductRecommendations(e,t,n,a={}){try{const{maxRecommendations:s=10,includePopular:r=!0,includeSimilar:i=!0,includePersonalized:o=!0}=a,c=[];if(o){const a=this.collaborativeFiltering(e,n,t);c.push(...a.slice(0,4))}if(i){const a=this.getUserPurchaseHistory(e,n),s=this.contentBasedFiltering(a,t);c.push(...s.slice(0,3))}if(r){const e=this.getPopularProducts(t,n);c.push(...e.slice(0,3))}const l=this.deduplicateAndScore(c);return{recommendations:l.slice(0,s),strategies:{collaborative:o,contentBased:i,popularity:r},insights:this.generateRecommendationInsights(l)}}catch(s){throw s}}collaborativeFiltering(e,t,n){const a=this.createUserItemMatrix(t),s=this.findSimilarUsers(e,a),r=[],i=a.get(e)||new Set;return s.forEach(({userId:e,similarity:t})=>{(a.get(e)||new Set).forEach(e=>{if(!i.has(e)){const a=n.find(t=>t.id===e);a&&r.push({product:a,score:t,reason:"Khách hàng tương tự cũng mua",strategy:"collaborative"})}})}),r}contentBasedFiltering(e,t){if(0===e.length)return[];const n=[],a=this.analyzeUserPreferences(e);return t.forEach(t=>{if(e.some(e=>e.productId===t.id))return;const s=this.calculateProductSimilarity(t,a);s>.3&&n.push({product:t,score:s,reason:"Phù hợp với sở thích của bạn",strategy:"content-based"})}),n.sort((e,t)=>t.score-e.score)}getPopularProducts(e,t){const n=new Map;t.forEach(e=>{e.items?.forEach(t=>{const a=n.get(t.productId)||{count:0,revenue:0,customers:new Set};a.count+=t.quantity||1,a.revenue+=(t.price||0)*(t.quantity||1),a.customers.add(e.customerId),n.set(t.productId,a)})});const a=[];return e.forEach(e=>{const t=n.get(e.id);if(t){const n=.4*t.count+.4*t.customers.size+t.revenue/1e6*.2;a.push({product:e,score:n,reason:`${t.customers.size} khách hàng đã mua`,strategy:"popularity"})}}),a.sort((e,t)=>t.score-e.score)}createUserItemMatrix(e){const t=new Map;return e.forEach(e=>{const n=e.customerId;t.has(n)||t.set(n,new Set),e.items?.forEach(e=>{t.get(n).add(e.productId)})}),t}findSimilarUsers(e,t,n=10){const a=t.get(e)||new Set,s=[];return t.forEach((t,n)=>{if(n===e)return;const r=this.calculateJaccardSimilarity(a,t);r>0&&s.push({userId:n,similarity:r})}),s.sort((e,t)=>t.similarity-e.similarity).slice(0,n)}calculateJaccardSimilarity(e,t){const n=new Set([...e].filter(e=>t.has(e))),a=new Set([...e,...t]);return a.size>0?n.size/a.size:0}getUserPurchaseHistory(e,t){const n=[];return t.filter(t=>t.customerId===e).forEach(e=>{e.items?.forEach(t=>{n.push({productId:t.productId,quantity:t.quantity||1,price:t.price||0,date:e.date})})}),n}analyzeUserPreferences(e){const t={categories:new Map,priceRange:{min:1/0,max:0,avg:0},brands:new Map,totalSpent:0,totalItems:0};return e.forEach(e=>{const n=e.product?.category||"unknown";t.categories.set(n,(t.categories.get(n)||0)+e.quantity);const a=e.price;t.priceRange.min=Math.min(t.priceRange.min,a),t.priceRange.max=Math.max(t.priceRange.max,a),t.totalSpent+=a*e.quantity,t.totalItems+=e.quantity;const s=e.product?.brand||"unknown";t.brands.set(s,(t.brands.get(s)||0)+e.quantity)}),t.priceRange.avg=t.totalItems>0?t.totalSpent/t.totalItems:0,t}calculateProductSimilarity(e,t){let n=0;const a=t.categories.get(e.category)||0,s=Math.max(...t.categories.values());s>0&&(n+=a/s*.4);const r=e.price||0,i=t.priceRange.avg;if(i>0){const e=Math.abs(r-i)/i;n+=.3*Math.max(0,1-e)}const o=t.brands.get(e.brand)||0,c=Math.max(...t.brands.values());return c>0&&(n+=o/c*.3),Math.min(1,n)}deduplicateAndScore(e){const t=new Map;return e.forEach(e=>{const n=e.product.id;if(t.has(n)){const a=t.get(n);a.score=Math.max(a.score,e.score),a.reason+=`, ${e.reason}`}else t.set(n,e)}),Array.from(t.values()).sort((e,t)=>t.score-e.score)}generateRecommendationInsights(e){const t=[],n=e.reduce((e,t)=>(e[t.strategy]=(e[t.strategy]||0)+1,e),{});t.push({type:"strategy_distribution",title:"Phân bố chiến lược gợi ý",data:n});const a=e.length>0?e.reduce((e,t)=>e+t.score,0)/e.length:0;return t.push({type:"confidence",title:"Độ tin cậy trung bình",value:(100*a).toFixed(1),description:"Mức độ phù hợp của các gợi ý"}),t}async getRealtimeRecommendations(e,t=null){try{const n=[];if(e.length>0){const t=this.getCrossSellRecommendations(e);n.push(...t)}if(e.length>0){const t=this.getUpsellRecommendations(e);n.push(...t)}if(t){const e=await this.getPersonalizedRecommendations(t);n.push(...e.slice(0,3))}return{recommendations:n.slice(0,6),type:"realtime",context:{cartSize:e.length,hasCustomer:!!t}}}catch(n){return{recommendations:[],type:"realtime"}}}getCrossSellRecommendations(e){const t=[],n=new Set(e.map(e=>e.category)),a={electronics:["accessories","cables"],clothing:["shoes","accessories"],food:["beverages","snacks"],books:["stationery","bookmarks"]};return n.forEach(e=>{(a[e]||[]).forEach(n=>{t.push({category:n,reason:`Phù hợp với ${e}`,strategy:"cross-sell",score:.7})})}),t}getUpsellRecommendations(e){const t=[];return e.forEach(e=>{const n=1.3*e.price;t.push({category:e.category,priceRange:[n,1.5*n],reason:"Phiên bản cao cấp hơn",strategy:"upsell",score:.6})}),t}async optimizePricing(e,t,n={},a={}){try{const{strategy:s="profit_maximization",elasticityThreshold:r=.5,maxPriceChange:i=.2,considerSeasonality:o=!0}=a,c=[];for(const a of e){const e=this.analyzeProductPricing(a,t,n),l=this.calculateOptimalPrice(a,e,s,{elasticityThreshold:r,maxPriceChange:i,considerSeasonality:o});c.push({product:a,currentPrice:a.price,optimizedPrice:l.price,priceChange:l.change,expectedImpact:l.impact,confidence:l.confidence,reasoning:l.reasoning})}return{optimizations:c.sort((e,t)=>t.expectedImpact.profit-e.expectedImpact.profit),strategy:s,summary:this.generatePricingOptimizationSummary(c),insights:this.generatePricingInsights(c,s)}}catch(s){throw s}}analyzeProductPricing(e,t,n){const a=t.filter(t=>t.items?.some(t=>t.productId===e.id)),s=this.calculatePriceElasticity(e,a),r=this.calculateSalesMetrics(e,a);return{elasticity:s,salesMetrics:r,competitiveAnalysis:this.analyzeCompetition(e,n),seasonalAnalysis:this.analyzeSeasonality(e,a),currentPerformance:this.assessCurrentPerformance(r,s)}}calculatePriceElasticity(e,t){if(t.length<10)return{elasticity:-1,confidence:"low",dataPoints:t.length};const n=this.groupOrdersByPeriod(t,"week");if(n.length<3)return{elasticity:-1,confidence:"low",dataPoints:n.length};const a=[],s=[];for(let c=1;c<n.length;c++){const e=n[c-1],t=n[c];if(e.avgPrice>0&&t.avgPrice>0){const n=(t.avgPrice-e.avgPrice)/e.avgPrice,r=(t.quantity-e.quantity)/e.quantity;Math.abs(n)>.01&&(a.push(n),s.push(r))}}if(a.length<2)return{elasticity:-1,confidence:"low",dataPoints:a.length};const r=a.reduce((e,t)=>e+t,0)/a.length,i=s.reduce((e,t)=>e+t,0)/s.length,o=0!==r?i/r:-1;return{elasticity:Math.abs(o),confidence:a.length>=5?"high":"medium",dataPoints:a.length,interpretation:this.interpretElasticity(o)}}groupOrdersByPeriod(e,t="week"){const n=new Map;return e.forEach(e=>{const a=new Date(e.date);let s;if("week"===t){const e=new Date(a);e.setDate(a.getDate()-a.getDay()),s=e.toISOString().split("T")[0]}else"month"===t&&(s=`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}`);n.has(s)||n.set(s,{orders:[],totalRevenue:0,quantity:0});const r=n.get(s);r.orders.push(e),e.items?.forEach(t=>{t.productId===e.productId&&(r.totalRevenue+=(t.price||0)*(t.quantity||1),r.quantity+=t.quantity||1)})}),Array.from(n.entries()).map(([e,t])=>({period:e,...t,avgPrice:t.quantity>0?t.totalRevenue/t.quantity:0})).sort((e,t)=>e.period.localeCompare(t.period))}calculateSalesMetrics(e,t){const n=t.reduce((t,n)=>t+n.items?.reduce((t,n)=>n.productId===e.id?t+(n.price||0)*(n.quantity||1):t,0)||0,0),a=t.reduce((t,n)=>t+n.items?.reduce((t,n)=>n.productId===e.id?t+(n.quantity||1):t,0)||0,0),s=a>0?n/a:0;return{totalRevenue:n,totalQuantity:a,avgOrderValue:s,salesVelocity:this.calculateSalesVelocity(t),profitMargin:this.estimateProfitMargin(e,s)}}calculateSalesVelocity(e){if(0===e.length)return 0;const t=new Date(Math.min(...e.map(e=>new Date(e.date)))),n=new Date(Math.max(...e.map(e=>new Date(e.date)))),a=Math.max(1,(n-t)/864e5);return e.reduce((e,t)=>e+t.items?.reduce((e,t)=>e+(t.quantity||1),0)||0,0)/a}estimateProfitMargin(e,t){const n=e.cost||.6*t;return t>0?(t-n)/t:0}analyzeCompetition(e,t){const n=t.competitors?.[e.category]||[];if(0===n.length)return{position:"unknown",avgCompetitorPrice:0,priceAdvantage:0,recommendation:"Cần thêm dữ liệu thị trường"};const a=n.reduce((e,t)=>e+t,0)/n.length,s=(e.price-a)/a;let r;return r=s>.1?"premium":s<-.1?"discount":"competitive",{position:r,avgCompetitorPrice:a,priceAdvantage:s,competitorCount:n.length,recommendation:this.getCompetitiveRecommendation(r,s)}}analyzeSeasonality(e,t){const n=new Array(12).fill(0),a=new Array(12).fill(0);t.forEach(t=>{const s=new Date(t.date).getMonth();t.items?.forEach(t=>{t.productId===e.id&&(n[s]+=t.quantity||1,a[s]++)})});const s=n.reduce((e,t)=>e+t,0)/12,r=n.map(e=>s>0?e/s:1),i=r[(new Date).getMonth()];return{monthlyData:n,seasonalityIndex:r,currentSeasonality:i,peakMonths:r.map((e,t)=>({month:t,index:e})).filter(e=>e.index>1.2).map(e=>e.month),lowMonths:r.map((e,t)=>({month:t,index:e})).filter(e=>e.index<.8).map(e=>e.month)}}calculateOptimalPrice(e,t,n,a){const{elasticityThreshold:s,maxPriceChange:r,considerSeasonality:i}=a,o=e.price;let c=o,l=[];if("profit_maximization"===n?(c=this.optimizeForProfit(e,t,o),l.push("Tối ưu hóa lợi nhuận")):"market_penetration"===n?(c=this.optimizeForMarketShare(e,t,o),l.push("Tăng thị phần")):"competitive"===n&&(c=this.optimizeForCompetition(e,t,o),l.push("Cạnh tranh thị trường")),i&&1!==t.seasonalAnalysis.currentSeasonality){const e=t.seasonalAnalysis.currentSeasonality;c*=e,l.push(`Điều chỉnh theo mùa (${(100*e).toFixed(0)}%)`)}const d=o*r;c=Math.max(o-d,Math.min(o+d,c));const h=(c-o)/o;return{price:Math.round(c),change:h,impact:this.calculatePriceChangeImpact(e,t,h),confidence:this.calculateOptimizationConfidence(t),reasoning:l.join(", ")}}optimizeForProfit(e,t,n){const{elasticity:a}=t.elasticity,{profitMargin:s}=t.salesMetrics;return"low"===a.confidence?s<.3?1.05*n:n:a.elasticity<1?1.1*n:1.02*n}optimizeForMarketShare(e,t,n){const{position:a,avgCompetitorPrice:s}=t.competitiveAnalysis;return"premium"===a?Math.min(.95*n,.98*s):"discount"===a?1.02*n:.95*s}optimizeForCompetition(e,t,n){const{avgCompetitorPrice:a}=t.competitiveAnalysis;return a>0?a:n}calculatePriceChangeImpact(e,t,n){const{elasticity:a}=t.elasticity,{totalRevenue:s,totalQuantity:r}=t.salesMetrics,i=-a.elasticity*n,o=r*(1+i),c=o*(e.price*(1+n));return{revenueChange:c-s,quantityChange:o-r,profit:.4*(c-s),marketShare:i>0?"increase":"decrease"}}calculateOptimizationConfidence(e){let t=0;return"high"===e.elasticity.confidence?t+=.4:"medium"===e.elasticity.confidence&&(t+=.2),e.salesMetrics.totalQuantity>100?t+=.3:e.salesMetrics.totalQuantity>20?t+=.2:t+=.1,e.competitiveAnalysis.competitorCount>3?t+=.2:e.competitiveAnalysis.competitorCount>0&&(t+=.1),e.seasonalAnalysis.monthlyData.some(e=>e>0)&&(t+=.1),Math.min(1,t)}generatePricingOptimizationSummary(e){const t=e.length,n=e.filter(e=>e.priceChange>0).length,a=e.filter(e=>e.priceChange<0).length;return{totalProducts:t,priceIncreases:n,priceDecreases:a,noChange:t-n-a,totalRevenueImpact:e.reduce((e,t)=>e+t.expectedImpact.revenueChange,0),avgPriceChange:e.reduce((e,t)=>e+t.priceChange,0)/t}}generatePricingInsights(e,t){const n=[];if("profit_maximization"===t){const t=e.filter(e=>e.expectedImpact.profit>0);n.push({type:"profit_opportunity",title:"Cơ hội tăng lợi nhuận",description:`${t.length} sản phẩm có thể tăng giá để tối ưu lợi nhuận`,value:t.length})}const a=e.filter(e=>Math.abs(e.expectedImpact.revenueChange)>1e6);return a.length>0&&n.push({type:"high_impact",title:"Sản phẩm có tác động cao",description:`${a.length} sản phẩm có tiềm năng tác động lớn đến doanh thu`,value:a.length}),n}interpretElasticity(e){return Math.abs(e)<.5?"Không đàn hồi - có thể tăng giá":Math.abs(e)<1?"Ít đàn hồi - thận trọng khi thay đổi giá":"Đàn hồi cao - nhạy cảm với thay đổi giá"}getCompetitiveRecommendation(e,t){return"premium"===e?"Duy trì vị thế cao cấp hoặc giảm giá để cạnh tranh":"discount"===e?"Tận dụng lợi thế giá hoặc tăng giá để cải thiện margin":"Vị thế cạnh tranh tốt, có thể điều chỉnh nhẹ"}assessCurrentPerformance(e,t){const{salesVelocity:n,profitMargin:a}=e;return n>10&&a>.3?"excellent":n>5&&a>.2?"good":n>1&&a>.1?"average":"poor"}},{Title:Ye,Text:Je}=o,{RangePicker:Ge}=w,He=()=>{const[n,a]=e.useState(!1),[s,o]=e.useState([]),[w,S]=e.useState([]),[M,b]=e.useState(null),[k,C]=e.useState([]),[I,P]=e.useState(null),[z,L]=e.useState(!1);e.useEffect(()=>{B()},[]);const B=async()=>{a(!0);try{const e=(await Fe.get("/customers/with-orders")).data.data||[];C(e),e.length>0&&await V(e)}catch(e){const t=q();C(t),await V(t)}finally{a(!1)}},V=async e=>{try{const t=await Ue.segmentCustomers(e);o(t.segments),S(t.insights),r.success(`Đã phân khúc ${e.length} khách hàng thành ${t.segments.length} nhóm`)}catch(t){r.error("Có lỗi xảy ra khi phân khúc khách hàng")}},q=()=>{const e=[],t=["Nguyễn Văn A","Trần Thị B","Lê Văn C","Phạm Thị D","Hoàng Văn E"];for(let n=0;n<100;n++){const a=Math.floor(20*Math.random())+1,s=[];for(let e=0;e<a;e++)s.push({id:`order_${n}_${e}`,date:new Date(Date.now()-365*Math.random()*24*60*60*1e3),total:Math.floor(2e6*Math.random())+1e5});e.push({id:`customer_${n}`,name:`${t[n%t.length]} ${n+1}`,email:`customer${n}@example.com`,phone:`0${Math.floor(9e8*Math.random())+1e8}`,createdAt:new Date(Date.now()-730*Math.random()*24*60*60*1e3),lastActivity:new Date(Date.now()-90*Math.random()*24*60*60*1e3),orders:s})}return e},F=[{title:"Phân khúc",dataIndex:"name",key:"name",render:(e,n)=>t.jsxs(h,{children:[t.jsx("div",{style:{width:12,height:12,borderRadius:"50%",backgroundColor:n.color}}),t.jsx(Je,{strong:!0,children:e})]})},{title:"Số lượng KH",dataIndex:"size",key:"size",render:e=>t.jsx(x,{value:e,prefix:t.jsx(A,{}),valueStyle:{fontSize:14}})},{title:"Doanh thu",key:"revenue",render:(e,n)=>t.jsxs(h,{direction:"vertical",size:"small",children:[t.jsxs(Je,{strong:!0,children:[(n.metrics?.totalRevenue||0).toLocaleString("vi-VN")," đ"]}),t.jsx(v,{percent:n.metrics?.revenuePercentage||0,size:"small",strokeColor:n.color})]})},{title:"RFM Trung bình",key:"rfm",render:(e,n)=>t.jsxs(h,{direction:"vertical",size:"small",children:[t.jsxs(Je,{children:["R: ",n.metrics?.avgRecency||0," ngày"]}),t.jsxs(Je,{children:["F: ",n.metrics?.avgFrequency||0," lần"]}),t.jsxs(Je,{children:["M: ",(n.metrics?.avgOrderValue||0).toLocaleString("vi-VN")," đ"]})]})},{title:"Chiến lược",dataIndex:"strategy",key:"strategy",render:e=>t.jsx(j,{title:e,children:t.jsx(Je,{ellipsis:!0,style:{maxWidth:200},children:e})})},{title:"Hành động",key:"actions",render:(e,n)=>t.jsx(h,{children:t.jsx(u,{size:"small",onClick:()=>{b(n),L(!0)},children:"Chi tiết"})})}],K=e.useMemo(()=>s.map(e=>({name:e.name,value:e.size,revenue:e.metrics?.totalRevenue||0,color:e.color})),[s]),U=e=>{const n={overview:t.jsx($,{}),top_segment:t.jsx(N,{}),at_risk:t.jsx(O,{})};return t.jsxs(d,{size:"small",children:[t.jsx(x,{title:e.title,value:e.value,prefix:n[e.type],valueStyle:{color:{overview:"#1890ff",top_segment:"#52c41a",at_risk:"#ff4d4f"}[e.type]},suffix:"top_segment"===e.type?"đ":""}),t.jsx(Je,{type:"secondary",style:{fontSize:12},children:e.description})]},e.type)};return n?t.jsxs("div",{style:{textAlign:"center",padding:50},children:[t.jsx(i,{size:"large"}),t.jsx("div",{style:{marginTop:16},children:t.jsx(Je,{children:"Đang phân tích dữ liệu khách hàng..."})})]}):t.jsxs("div",{style:{padding:24},children:[t.jsx(c,{gutter:[16,16],style:{marginBottom:24},children:t.jsx(l,{span:24,children:t.jsx(d,{children:t.jsxs(c,{justify:"space-between",align:"middle",children:[t.jsxs(l,{children:[t.jsxs(Ye,{level:2,children:[t.jsx(D,{})," Phân khúc khách hàng AI"]}),t.jsx(Je,{type:"secondary",children:"Sử dụng Machine Learning để phân tích và phân khúc khách hàng theo RFM"})]}),t.jsx(l,{children:t.jsxs(h,{children:[t.jsx(u,{icon:t.jsx(T,{}),onClick:B,loading:n,children:"Phân tích lại"}),t.jsx(u,{icon:t.jsx(R,{}),onClick:()=>{try{const e=Ue.exportSegmentationResults(s),t=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.download=`customer-segmentation-${Date.now()}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n),r.success("Đã xuất kết quả phân khúc")}catch(e){r.error("Có lỗi khi xuất dữ liệu")}},disabled:0===s.length,children:"Xuất kết quả"})]})})]})})})}),t.jsx(c,{gutter:[16,16],style:{marginBottom:24},children:w.map(e=>t.jsx(l,{span:8,children:U(e)},e.type))}),t.jsxs(c,{gutter:[16,16],style:{marginBottom:24},children:[t.jsx(l,{span:12,children:t.jsx(d,{title:"Phân bố khách hàng theo phân khúc",size:"small",children:t.jsx(W,{width:"100%",height:300,children:t.jsx(Q,{children:t.jsx(X,{data:K,cx:"50%",cy:"50%",outerRadius:100,fill:"#8884d8",dataKey:"value",label:({name:e,percent:t})=>`${e} ${(100*t).toFixed(0)}%`,children:K.map((e,n)=>t.jsx(Z,{fill:e.color},`cell-${n}`))})})})})}),t.jsx(l,{span:12,children:t.jsx(d,{title:"Doanh thu theo phân khúc",size:"small",children:t.jsx(W,{width:"100%",height:300,children:t.jsxs(ee,{data:K,children:[t.jsx(te,{strokeDasharray:"3 3"}),t.jsx(ne,{dataKey:"name"}),t.jsx(ae,{}),t.jsx(se,{dataKey:"revenue",fill:"#1890ff"})]})})})})]}),t.jsx(d,{title:"Chi tiết phân khúc khách hàng",size:"small",children:t.jsx(m,{columns:F,dataSource:s,rowKey:"clusterId",pagination:{pageSize:10},size:"small"})}),t.jsx(g,{title:`Chi tiết phân khúc: ${M?.name}`,open:z,onCancel:()=>L(!1),width:800,footer:null,children:M&&t.jsxs("div",{children:[t.jsx(c,{gutter:[16,16],style:{marginBottom:16},children:t.jsx(l,{span:24,children:t.jsx(p,{message:M.description,description:M.strategy,type:"info",showIcon:!0})})}),t.jsxs(y,{column:2,size:"small",bordered:!0,children:[t.jsx(y.Item,{label:"Số lượng khách hàng",children:M.size}),t.jsxs(y.Item,{label:"Tổng doanh thu",children:[(M.metrics?.totalRevenue||0).toLocaleString("vi-VN")," đ"]}),t.jsxs(y.Item,{label:"Recency trung bình",children:[M.metrics?.avgRecency||0," ngày"]}),t.jsxs(y.Item,{label:"Frequency trung bình",children:[M.metrics?.avgFrequency||0," lần"]}),t.jsxs(y.Item,{label:"AOV trung bình",children:[(M.metrics?.avgOrderValue||0).toLocaleString("vi-VN")," đ"]}),t.jsxs(y.Item,{label:"% Doanh thu",children:[M.metrics?.revenuePercentage||0,"%"]})]}),t.jsxs("div",{style:{marginTop:16},children:[t.jsxs(Ye,{level:5,children:[t.jsx(_,{})," Khuyến nghị hành động"]}),t.jsx(f,{size:"small",dataSource:Ue.getSegmentRecommendations(M),renderItem:e=>t.jsxs(f.Item,{children:[t.jsx(E,{style:{color:"#faad14",marginRight:8}}),e]})})]})]})})]})},{Title:We,Text:Qe}=o,{RangePicker:Xe}=w,{Option:Ze}=b,et=()=>{const[n,a]=e.useState(!1),[o,g]=e.useState(null),[y,f]=e.useState([]),[v,w]=e.useState(30),[b,k]=e.useState("revenue"),[C,I]=e.useState([s().subtract(90,"day"),s()]);e.useEffect(()=>{P()},[C]);const P=async()=>{a(!0);try{const e=(await Fe.get("/orders/sales-data",{params:{startDate:C[0].format("YYYY-MM-DD"),endDate:C[1].format("YYYY-MM-DD")}})).data.data||[];f(e),e.length>0&&await z(e)}catch(e){const t=D();f(t),await z(t)}finally{a(!1)}},z=async e=>{try{const t=await Ue.forecastSales(e,v);g(t),r.success(`Đã tạo dự báo ${v} ngày tới`)}catch(t){r.error("Có lỗi xảy ra khi tạo dự báo")}},D=()=>{const e=[],t=s().subtract(90,"day");for(let n=0;n<90;n++){const a=t.add(n,"day"),s=a.day();let r=1e6+5e5*Math.random();0!==s&&6!==s||(r*=1.5),r+=5e3*n,r+=2e5*(Math.random()-.5),e.push({id:`order_${n}`,date:a.toISOString(),total:Math.max(0,r),items:[{quantity:Math.floor(10*Math.random())+1}]})}return e},E=e.useMemo(()=>{if(!o)return[];const e=y.map(e=>({date:s(e.date).format("MM/DD"),actual:e.total,type:"historical"})),t=o.forecast.map(e=>({date:s(e.date).format("MM/DD"),predicted:e.predicted,lowerBound:e.lowerBound,upperBound:e.upperBound,type:"forecast"}));return[...e.slice(-30),...t]},[o,y]),A=e.useMemo(()=>{if(!o)return null;const{mape:e,rmse:t,mae:n}=o.accuracy;return[{name:"MAPE",value:e.toFixed(2),suffix:"%",description:"Mean Absolute Percentage Error"},{name:"RMSE",value:t.toLocaleString("vi-VN"),suffix:"đ",description:"Root Mean Square Error"},{name:"MAE",value:n.toLocaleString("vi-VN"),suffix:"đ",description:"Mean Absolute Error"}]},[o]);return n?t.jsxs("div",{style:{textAlign:"center",padding:50},children:[t.jsx(i,{size:"large"}),t.jsx("div",{style:{marginTop:16},children:t.jsx(Qe,{children:"Đang phân tích dữ liệu bán hàng..."})})]}):t.jsxs("div",{style:{padding:24},children:[t.jsx(c,{gutter:[16,16],style:{marginBottom:24},children:t.jsx(l,{span:24,children:t.jsx(d,{children:t.jsxs(c,{justify:"space-between",align:"middle",children:[t.jsxs(l,{children:[t.jsxs(We,{level:2,children:[t.jsx(L,{})," Dự báo doanh thu AI"]}),t.jsx(Qe,{type:"secondary",children:"Sử dụng Machine Learning để dự báo doanh thu và xu hướng bán hàng"})]}),t.jsx(l,{children:t.jsxs(h,{children:[t.jsx(Xe,{value:C,onChange:I,format:"DD/MM/YYYY"}),t.jsx(S,{min:7,max:90,value:v,onChange:w,addonAfter:"ngày",style:{width:120}}),t.jsx(u,{icon:t.jsx(T,{}),onClick:P,loading:n,children:"Tạo dự báo"}),t.jsx(u,{icon:t.jsx(R,{}),onClick:()=>{if(!o)return;const e={timestamp:(new Date).toISOString(),forecastPeriods:v,accuracy:o.accuracy,forecast:o.forecast,insights:o.insights},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.download=`sales-forecast-${Date.now()}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n),r.success("Đã xuất dự báo")},disabled:!o,children:"Xuất dự báo"})]})})]})})})}),A&&t.jsx(c,{gutter:[16,16],style:{marginBottom:24},children:A.map(e=>t.jsx(l,{span:8,children:t.jsx(d,{size:"small",children:t.jsx(x,{title:t.jsx(j,{title:e.description,children:e.name}),value:e.value,suffix:e.suffix,prefix:t.jsx(B,{})})})},e.name))}),t.jsx(c,{gutter:[16,16],style:{marginBottom:24},children:t.jsx(l,{span:24,children:t.jsx(d,{title:"Biểu đồ dự báo doanh thu",size:"small",children:t.jsx(W,{width:"100%",height:400,children:t.jsxs(re,{data:E,children:[t.jsx(te,{strokeDasharray:"3 3"}),t.jsx(ne,{dataKey:"date"}),t.jsx(ae,{}),t.jsx(ie,{formatter:(e,t)=>[`${e?.toLocaleString("vi-VN")} đ`,"actual"===t?"Thực tế":"predicted"===t?"Dự báo":"lowerBound"===t?"Giới hạn dưới":"Giới hạn trên"]}),t.jsx(oe,{}),t.jsx(ce,{type:"monotone",dataKey:"actual",stroke:"#1890ff",strokeWidth:2,name:"Thực tế",connectNulls:!1}),t.jsx(ce,{type:"monotone",dataKey:"predicted",stroke:"#52c41a",strokeWidth:2,strokeDasharray:"5 5",name:"Dự báo",connectNulls:!1}),t.jsx(le,{type:"monotone",dataKey:"upperBound",stackId:"1",stroke:"none",fill:"#52c41a",fillOpacity:.1}),t.jsx(le,{type:"monotone",dataKey:"lowerBound",stackId:"1",stroke:"none",fill:"#ffffff",fillOpacity:1})]})})})})}),o?.insights&&t.jsx(c,{gutter:[16,16],style:{marginBottom:24},children:t.jsx(l,{span:24,children:t.jsx(d,{title:t.jsxs(t.Fragment,{children:[t.jsx(_,{})," Insights và khuyến nghị"]}),size:"small",children:t.jsx(h,{direction:"vertical",style:{width:"100%"},children:o.insights.map((e,n)=>t.jsx(p,{message:e.title,description:e.description,type:"positive"===e.impact?"success":"negative"===e.impact?"error":"info",showIcon:!0},n))})})})}),o&&t.jsx(d,{title:"Chi tiết dự báo",size:"small",children:t.jsx(m,{dataSource:o.forecast.slice(0,14),rowKey:"date",pagination:!1,size:"small",columns:[{title:"Ngày",dataIndex:"date",key:"date",render:e=>s(e).format("DD/MM/YYYY")},{title:"Dự báo",dataIndex:"predicted",key:"predicted",render:e=>`${e.toLocaleString("vi-VN")} đ`},{title:"Khoảng tin cậy",key:"confidence",render:(e,n)=>t.jsxs(h,{children:[t.jsxs(Qe,{type:"secondary",children:[n.lowerBound?.toLocaleString("vi-VN")," đ"]}),t.jsx(Qe,{children:"-"}),t.jsxs(Qe,{type:"secondary",children:[n.upperBound?.toLocaleString("vi-VN")," đ"]})]})},{title:"Xu hướng",dataKey:"trend",key:"trend",render:e=>t.jsxs(M,{color:e>0?"green":e<0?"red":"blue",children:[e>0?t.jsx(V,{}):t.jsx(q,{}),Math.abs(e).toLocaleString("vi-VN")," đ"]})}]})})]})},{Title:tt,Text:nt}=o,{Option:at}=b,st=({customerId:n=null,currentCart:a=[],onAddToCart:s,mode:o="full"})=>{const[m,g]=e.useState(!1),[y,j]=e.useState([]),[w,S]=e.useState([]),[P,z]=e.useState([]),[T,R]=e.useState([]),[O,$]=e.useState("all"),[L,q]=e.useState(!0);e.useEffect(()=>{U()},[n]),e.useEffect(()=>{L&&a.length>0&&J()},[a,L]);const U=async()=>{g(!0);try{const[e,t]=await Promise.all([Fe.get("/products"),Fe.get("/orders")]);z(e.data.data||[]),R(t.data.data||[]),n&&await Y(e.data.data||[],t.data.data||[])}catch(e){const t=G(),a=H();z(t),R(a),n&&await Y(t,a)}finally{g(!1)}},Y=async(e,t)=>{try{const a={maxRecommendations:"widget"===o?4:10,includePopular:"all"===O||"popular"===O,includeSimilar:"all"===O||"similar"===O,includePersonalized:"all"===O||"personalized"===O},s=await Ue.generateProductRecommendations(n,e,t,a);j(s.recommendations),S(s.insights)}catch(a){r.error("Có lỗi khi tạo gợi ý sản phẩm")}},J=async()=>{try{const e=await Ue.getRealtimeRecommendations(a,n);j(e.recommendations)}catch(e){}},G=()=>{const e=["Electronics","Clothing","Books","Food","Accessories"],t=["Samsung","Apple","Nike","Adidas","Sony"];return Array.from({length:50},(n,a)=>({id:`product_${a}`,name:`Sản phẩm ${a+1}`,category:e[a%e.length],brand:t[a%t.length],price:Math.floor(2e6*Math.random())+1e5,description:`Mô tả sản phẩm ${a+1}`,image:`https://via.placeholder.com/150?text=Product${a+1}`,rating:2*Math.random()+3,reviews:Math.floor(100*Math.random())+10}))},H=()=>{const e=[],t=["customer_1","customer_2","customer_3"];for(let n=0;n<100;n++)e.push({id:`order_${n}`,customerId:t[n%t.length],date:new Date(Date.now()-90*Math.random()*24*60*60*1e3),items:[{productId:`product_${Math.floor(50*Math.random())}`,quantity:Math.floor(3*Math.random())+1,price:Math.floor(1e6*Math.random())+5e4}]});return e},W=e=>({collaborative:t.jsx(A,{}),"content-based":t.jsx(E,{}),popularity:t.jsx(N,{}),"cross-sell":t.jsx(K,{}),upsell:t.jsx(V,{})}[e]||t.jsx(_,{})),Q=e=>({collaborative:"blue","content-based":"green",popularity:"gold","cross-sell":"purple",upsell:"orange"}[e]||"default"),X=(e,n)=>{const{product:a,score:i,reason:c,strategy:l}=e;return t.jsx(d,{size:"small",hoverable:!0,style:{marginBottom:8},actions:"widget"!==o?[t.jsx(u,{type:"primary",size:"small",icon:t.jsx(F,{}),onClick:()=>(e=>{s&&(s(e),r.success(`Đã thêm ${e.name} vào giỏ hàng`))})(a),children:"Thêm vào giỏ"})]:[],children:t.jsx(d.Meta,{avatar:t.jsx(I,{src:a.image,size:"widget"===o?"small":"default"}),title:t.jsxs(h,{children:[t.jsx(nt,{strong:!0,style:{fontSize:"widget"===o?12:14},children:a.name}),t.jsx(M,{color:Q(l),icon:W(l),size:"small",children:l})]}),description:t.jsxs(h,{direction:"vertical",size:"small",style:{width:"100%"},children:[t.jsx(nt,{type:"secondary",style:{fontSize:12},children:c}),t.jsxs(h,{children:[t.jsxs(nt,{strong:!0,style:{color:"#1890ff"},children:[a.price?.toLocaleString("vi-VN")," đ"]}),a.rating&&t.jsx(C,{disabled:!0,defaultValue:a.rating,size:"small",style:{fontSize:12}})]}),t.jsx(v,{percent:Math.round(100*i),size:"small",format:()=>`${Math.round(100*i)}% phù hợp`})]})})},a.id)};return"widget"===o?t.jsx(d,{title:t.jsxs(h,{children:[t.jsx(D,{}),t.jsx(nt,{children:"Gợi ý cho bạn"})]}),size:"small",style:{maxHeight:400,overflow:"auto"},children:m?t.jsx(i,{}):t.jsx(f,{dataSource:y.slice(0,4),renderItem:(e,n)=>t.jsx(f.Item,{style:{padding:"8px 0"},children:X(e)})})}):t.jsxs("div",{style:{padding:"pos"===o?16:24},children:[t.jsx(c,{gutter:[16,16],style:{marginBottom:24},children:t.jsx(l,{span:24,children:t.jsx(d,{children:t.jsxs(c,{justify:"space-between",align:"middle",children:[t.jsxs(l,{children:[t.jsxs(tt,{level:"pos"===o?4:2,children:[t.jsx(D,{})," Gợi ý sản phẩm AI"]}),t.jsx(nt,{type:"secondary",children:"Recommendations được tạo bằng Machine Learning"})]}),t.jsx(l,{children:t.jsxs(h,{children:[t.jsxs(b,{value:O,onChange:$,style:{width:150},size:"small",children:[t.jsx(at,{value:"all",children:"Tất cả"}),t.jsx(at,{value:"personalized",children:"Cá nhân hóa"}),t.jsx(at,{value:"similar",children:"Tương tự"}),t.jsx(at,{value:"popular",children:"Phổ biến"})]}),t.jsx(k,{checked:L,onChange:q,checkedChildren:"Auto",unCheckedChildren:"Manual",size:"small"})]})})]})})})}),w.length>0&&t.jsx(c,{gutter:[16,16],style:{marginBottom:24},children:w.map((e,n)=>t.jsx(l,{span:12,children:t.jsxs(d,{size:"small",children:[t.jsx(x,{title:e.title,value:e.value,suffix:"confidence"===e.type?"%":"",prefix:t.jsx(B,{})}),e.description&&t.jsx(nt,{type:"secondary",style:{fontSize:12},children:e.description})]})},n))}),a.length>0&&t.jsx(c,{style:{marginBottom:24},children:t.jsx(l,{span:24,children:t.jsx(p,{message:"Gợi ý dựa trên giỏ hàng hiện tại",description:`${a.length} sản phẩm trong giỏ hàng`,type:"info",showIcon:!0})})}),t.jsx(c,{gutter:[16,16],children:m?t.jsxs(l,{span:24,style:{textAlign:"center",padding:50},children:[t.jsx(i,{size:"large"}),t.jsx("div",{style:{marginTop:16},children:t.jsx(nt,{children:"Đang tạo gợi ý sản phẩm..."})})]}):y.length>0?y.map((e,n)=>t.jsx(l,{span:"pos"===o?12:8,children:X(e)},e.product.id)):t.jsx(l,{span:24,children:t.jsx(d,{children:t.jsxs("div",{style:{textAlign:"center",padding:50},children:[t.jsx(_,{style:{fontSize:48,color:"#d9d9d9"}}),t.jsx("div",{style:{marginTop:16},children:t.jsx(nt,{type:"secondary",children:"Chưa có gợi ý sản phẩm. Thêm sản phẩm vào giỏ hàng hoặc chọn khách hàng để nhận gợi ý."})})]})})})})]})},{Title:rt,Text:it}=o,{Option:ot}=b,ct=()=>{const[n,a]=e.useState(!1),[s,o]=e.useState([]),[f,j]=e.useState([]),[w,S]=e.useState(null),[k,C]=e.useState([]),[I,P]=e.useState([]),[z,D]=e.useState("profit_maximization"),[R,E]=e.useState(null),[A,O]=e.useState(!1);e.useEffect(()=>{N()},[]);const N=async()=>{a(!0);try{const[e,t]=await Promise.all([Fe.get("/products"),Fe.get("/orders")]);C(e.data.data||[]),P(t.data.data||[]),await L(e.data.data||[],t.data.data||[])}catch(e){const t=B(),n=F();C(t),P(n),await L(t,n)}finally{a(!1)}},L=async(e,t)=>{try{const n={competitors:{Electronics:[12e5,15e5,18e5],Clothing:[5e5,8e5,12e5],Books:[15e4,2e5,3e5]}},a={strategy:z,elasticityThreshold:.5,maxPriceChange:.2,considerSeasonality:!0},s=await Ue.optimizePricing(e.slice(0,20),t,n,a);o(s.optimizations),j(s.insights),S(s.summary),r.success(`Đã tối ưu hóa giá cho ${s.optimizations.length} sản phẩm`)}catch(n){r.error("Có lỗi khi tối ưu hóa giá")}},B=()=>{const e=["Electronics","Clothing","Books","Food","Accessories"];return Array.from({length:50},(t,n)=>({id:`product_${n}`,name:`Sản phẩm ${n+1}`,category:e[n%e.length],price:Math.floor(2e6*Math.random())+1e5,cost:Math.floor(1e6*Math.random())+5e4,description:`Mô tả sản phẩm ${n+1}`}))},F=()=>{const e=[];for(let t=0;t<200;t++)e.push({id:`order_${t}`,customerId:`customer_${Math.floor(20*Math.random())}`,date:new Date(Date.now()-90*Math.random()*24*60*60*1e3),items:[{productId:`product_${Math.floor(50*Math.random())}`,quantity:Math.floor(3*Math.random())+1,price:Math.floor(1e6*Math.random())+5e4}]});return e},K=e=>{g.confirm({title:"Áp dụng tối ưu hóa giá",content:`Bạn có chắc muốn thay đổi giá ${e.product.name} từ ${e.currentPrice.toLocaleString("vi-VN")} đ thành ${e.optimizedPrice.toLocaleString("vi-VN")} đ?`,onOk:async()=>{try{await Fe.put(`/products/${e.product.id}`,{price:e.optimizedPrice}),r.success("Đã cập nhật giá sản phẩm"),N()}catch(t){r.error("Có lỗi khi cập nhật giá")}}})},Y=[{title:"Sản phẩm",dataIndex:["product","name"],key:"name",render:(e,n)=>t.jsxs(h,{direction:"vertical",size:"small",children:[t.jsx(it,{strong:!0,children:e}),t.jsx(M,{color:"blue",children:n.product.category})]})},{title:"Giá hiện tại",dataIndex:"currentPrice",key:"currentPrice",render:e=>t.jsxs(it,{children:[e.toLocaleString("vi-VN")," đ"]})},{title:"Giá tối ưu",dataIndex:"optimizedPrice",key:"optimizedPrice",render:(e,n)=>t.jsxs(h,{children:[t.jsxs(it,{strong:!0,style:{color:n.priceChange>0?"#52c41a":"#ff4d4f"},children:[e.toLocaleString("vi-VN")," đ"]}),n.priceChange>0?t.jsx(V,{style:{color:"#52c41a"}}):t.jsx(q,{style:{color:"#ff4d4f"}})]})},{title:"Thay đổi",dataIndex:"priceChange",key:"priceChange",render:e=>t.jsxs(M,{color:e>0?"green":e<0?"red":"blue",children:[(100*e).toFixed(1),"%"]})},{title:"Tác động dự kiến",key:"impact",render:(e,n)=>t.jsxs(h,{direction:"vertical",size:"small",children:[t.jsxs(it,{children:["Doanh thu: ",n.expectedImpact.revenueChange>0?"+":"",n.expectedImpact.revenueChange.toLocaleString("vi-VN")," đ"]}),t.jsxs(it,{children:["Lợi nhuận: ",n.expectedImpact.profit>0?"+":"",n.expectedImpact.profit.toLocaleString("vi-VN")," đ"]})]})},{title:"Độ tin cậy",dataIndex:"confidence",key:"confidence",render:e=>t.jsx(v,{percent:Math.round(100*e),size:"small",status:e>.7?"success":e>.4?"normal":"exception"})},{title:"Hành động",key:"actions",render:(e,n)=>t.jsxs(h,{children:[t.jsx(u,{size:"small",onClick:()=>{E(n),O(!0)},children:"Chi tiết"}),t.jsx(u,{type:"primary",size:"small",onClick:()=>K(n),disabled:Math.abs(n.priceChange)<.01,children:"Áp dụng"})]})}],J=e.useMemo(()=>s.map(e=>({name:e.product.name.substring(0,10)+"...",currentPrice:e.currentPrice,optimizedPrice:e.optimizedPrice,revenueImpact:e.expectedImpact.revenueChange,confidence:100*e.confidence})),[s]);return n?t.jsxs("div",{style:{textAlign:"center",padding:50},children:[t.jsx(i,{size:"large"}),t.jsx("div",{style:{marginTop:16},children:t.jsx(it,{children:"Đang phân tích và tối ưu hóa giá..."})})]}):t.jsxs("div",{style:{padding:24},children:[t.jsx(c,{gutter:[16,16],style:{marginBottom:24},children:t.jsx(l,{span:24,children:t.jsx(d,{children:t.jsxs(c,{justify:"space-between",align:"middle",children:[t.jsxs(l,{children:[t.jsxs(rt,{level:2,children:[t.jsx(U,{})," Tối ưu hóa giá AI"]}),t.jsx(it,{type:"secondary",children:"Sử dụng Machine Learning để tối ưu hóa giá bán và tăng lợi nhuận"})]}),t.jsx(l,{children:t.jsxs(h,{children:[t.jsxs(b,{value:z,onChange:e=>{D(e),L(k,I)},style:{width:200},children:[t.jsx(ot,{value:"profit_maximization",children:"Tối ưu lợi nhuận"}),t.jsx(ot,{value:"market_penetration",children:"Thâm nhập thị trường"}),t.jsx(ot,{value:"competitive",children:"Cạnh tranh"})]}),t.jsx(u,{icon:t.jsx(T,{}),onClick:N,loading:n,children:"Tối ưu lại"})]})})]})})})}),w&&t.jsxs(c,{gutter:[16,16],style:{marginBottom:24},children:[t.jsx(l,{span:6,children:t.jsx(d,{size:"small",children:t.jsx(x,{title:"Tổng sản phẩm",value:w.totalProducts,prefix:t.jsx($,{})})})}),t.jsx(l,{span:6,children:t.jsx(d,{size:"small",children:t.jsx(x,{title:"Tăng giá",value:w.priceIncreases,prefix:t.jsx(V,{}),valueStyle:{color:"#52c41a"}})})}),t.jsx(l,{span:6,children:t.jsx(d,{size:"small",children:t.jsx(x,{title:"Giảm giá",value:w.priceDecreases,prefix:t.jsx(q,{}),valueStyle:{color:"#ff4d4f"}})})}),t.jsx(l,{span:6,children:t.jsx(d,{size:"small",children:t.jsx(x,{title:"Tác động doanh thu",value:w.totalRevenueImpact,prefix:t.jsx(U,{}),suffix:"đ",valueStyle:{color:w.totalRevenueImpact>0?"#52c41a":"#ff4d4f"}})})})]}),f.length>0&&t.jsx(c,{gutter:[16,16],style:{marginBottom:24},children:f.map((e,n)=>t.jsx(l,{span:12,children:t.jsx(p,{message:e.title,description:e.description,type:"info",showIcon:!0,icon:t.jsx(_,{})})},n))}),t.jsxs(c,{gutter:[16,16],style:{marginBottom:24},children:[t.jsx(l,{span:12,children:t.jsx(d,{title:"So sánh giá hiện tại vs tối ưu",size:"small",children:t.jsx(W,{width:"100%",height:300,children:t.jsxs(ee,{data:J.slice(0,10),children:[t.jsx(te,{strokeDasharray:"3 3"}),t.jsx(ne,{dataKey:"name"}),t.jsx(ae,{}),t.jsx(ie,{formatter:(e,t)=>[`${e.toLocaleString("vi-VN")} đ`,"currentPrice"===t?"Giá hiện tại":"Giá tối ưu"]}),t.jsx(oe,{}),t.jsx(se,{dataKey:"currentPrice",fill:"#1890ff",name:"Giá hiện tại"}),t.jsx(se,{dataKey:"optimizedPrice",fill:"#52c41a",name:"Giá tối ưu"})]})})})}),t.jsx(l,{span:12,children:t.jsx(d,{title:"Tác động doanh thu vs Độ tin cậy",size:"small",children:t.jsx(W,{width:"100%",height:300,children:t.jsxs(de,{data:J,children:[t.jsx(te,{strokeDasharray:"3 3"}),t.jsx(ne,{dataKey:"confidence",name:"Độ tin cậy",unit:"%"}),t.jsx(ae,{dataKey:"revenueImpact",name:"Tác động doanh thu"}),t.jsx(ie,{formatter:(e,t)=>["confidence"===t?`${e}%`:`${e.toLocaleString("vi-VN")} đ`,"confidence"===t?"Độ tin cậy":"Tác động doanh thu"]}),t.jsx(he,{dataKey:"revenueImpact",fill:"#8884d8"})]})})})})]}),t.jsx(d,{title:"Chi tiết tối ưu hóa giá",size:"small",children:t.jsx(m,{columns:Y,dataSource:s,rowKey:e=>e.product.id,pagination:{pageSize:10},size:"small"})}),t.jsx(g,{title:`Chi tiết tối ưu hóa: ${R?.product.name}`,open:A,onCancel:()=>O(!1),width:800,footer:[t.jsx(u,{onClick:()=>O(!1),children:"Đóng"},"close"),t.jsx(u,{type:"primary",onClick:()=>{K(R),O(!1)},children:"Áp dụng tối ưu hóa"},"apply")],children:R&&t.jsxs("div",{children:[t.jsxs(y,{column:2,size:"small",bordered:!0,children:[t.jsx(y.Item,{label:"Sản phẩm",children:R.product.name}),t.jsx(y.Item,{label:"Danh mục",children:R.product.category}),t.jsxs(y.Item,{label:"Giá hiện tại",children:[R.currentPrice.toLocaleString("vi-VN")," đ"]}),t.jsxs(y.Item,{label:"Giá tối ưu",children:[R.optimizedPrice.toLocaleString("vi-VN")," đ"]}),t.jsxs(y.Item,{label:"Thay đổi",children:[(100*R.priceChange).toFixed(1),"%"]}),t.jsxs(y.Item,{label:"Độ tin cậy",children:[(100*R.confidence).toFixed(1),"%"]}),t.jsx(y.Item,{label:"Lý do",span:2,children:R.reasoning})]}),t.jsxs("div",{style:{marginTop:16},children:[t.jsx(rt,{level:5,children:"Tác động dự kiến"}),t.jsxs(c,{gutter:[16,16],children:[t.jsx(l,{span:8,children:t.jsx(x,{title:"Thay đổi doanh thu",value:R.expectedImpact.revenueChange,suffix:"đ",valueStyle:{color:R.expectedImpact.revenueChange>0?"#52c41a":"#ff4d4f"}})}),t.jsx(l,{span:8,children:t.jsx(x,{title:"Thay đổi lợi nhuận",value:R.expectedImpact.profit,suffix:"đ",valueStyle:{color:R.expectedImpact.profit>0?"#52c41a":"#ff4d4f"}})}),t.jsx(l,{span:8,children:t.jsx(x,{title:"Thay đổi số lượng",value:R.expectedImpact.quantityChange,suffix:"sp",valueStyle:{color:R.expectedImpact.quantityChange>0?"#52c41a":"#ff4d4f"}})})]})]})]})})]})},{Title:lt,Text:dt,Paragraph:ht}=o,{TabPane:ut}=P,{Option:mt}=b,{TextArea:gt}=z,pt=Object.freeze(Object.defineProperty({__proto__:null,default:()=>{const[n,a]=e.useState(!1),[i,o]=e.useState("recommendation"),[m,g]=e.useState({}),[p,y]=e.useState([]),[f,x]=e.useState([]),[j,w]=e.useState([]),[S,b]=e.useState([]),[k,C]=e.useState([]),[I,z]=e.useState([]),[R,_]=e.useState({}),[E,O]=e.useState({}),[N,$]=e.useState(!1),[B,V]=e.useState(!1);e.useEffect(()=>{q()},[]);const q=async()=>{a(!0);try{await Promise.all([K(),W(),Q(),X(),Z(),ee(),te(),ne()])}catch(e){}finally{a(!1)}},K=async()=>{try{const e=await Fe.get("/ai/models/status");e.data.success&&g(e.data.data)}catch(e){g({recommendation:{status:"active",accuracy:87.5,lastTrained:"2024-03-10"},demand_forecasting:{status:"active",accuracy:92.3,lastTrained:"2024-03-08"},price_optimization:{status:"training",accuracy:85.1,lastTrained:"2024-03-05"},customer_segmentation:{status:"active",accuracy:89.7,lastTrained:"2024-03-12"},anomaly_detection:{status:"active",accuracy:94.2,lastTrained:"2024-03-11"},chatbot:{status:"active",accuracy:91.8,lastTrained:"2024-03-09"}})}},W=async()=>{try{const e=await Fe.get("/ai/recommendations");e.data.success&&x(e.data.data)}catch(e){x([{type:"product_recommendation",title:"Khuyến nghị sản phẩm cho khách hàng VIP",description:"Khách hàng Nguyễn Văn A có 85% khả năng mua Cà phê premium",confidence:85,impact:"high",action:"Gửi offer đặc biệt",customer:"Nguyễn Văn A",product:"Cà phê premium"},{type:"cross_sell",title:"Cơ hội bán chéo",description:"Khách mua Coca Cola có 70% khả năng mua snacks",confidence:70,impact:"medium",action:"Đặt snacks gần khu vực nước uống",customer:null,product:"Snacks combo"},{type:"upsell",title:"Cơ hội nâng cấp",description:"Khách hàng thường có thể nâng cấp lên Premium",confidence:65,impact:"high",action:"Chương trình loyalty đặc biệt",customer:"Segment Regular",product:"Premium membership"}])}},Q=async()=>{try{const e=await Fe.get("/ai/customer-insights");e.data.success&&w(e.data.data)}catch(e){w([{segment:"High-Value Customers",count:89,characteristics:["Mua hàng thường xuyên","Giá trị đơn hàng cao","Ít nhạy cảm giá"],behavior:"Thích sản phẩm premium, mua vào cuối tuần",churnRisk:"low",recommendations:["Chương trình VIP","Early access products"]},{segment:"Price-Sensitive Shoppers",count:234,characteristics:["Nhạy cảm với giá","Tìm kiếm khuyến mãi","Mua theo mùa"],behavior:"So sánh giá, mua khi có sale",churnRisk:"medium",recommendations:["Flash sales","Loyalty points program"]},{segment:"Occasional Buyers",count:156,characteristics:["Mua không thường xuyên","Đơn hàng nhỏ","Cần kích thích"],behavior:"Mua khi có nhu cầu cụ thể",churnRisk:"high",recommendations:["Remarketing campaigns","Personalized offers"]}])}},X=async()=>{try{const e=await Fe.get("/ai/price-optimization");e.data.success&&b(e.data.data)}catch(e){b([{product:"Coca Cola 330ml",currentPrice:12e3,optimizedPrice:13500,expectedIncrease:12.5,confidence:87,reasoning:"Nhu cầu cao, ít cạnh tranh trong khu vực"},{product:"Bánh mì sandwich",currentPrice:25e3,optimizedPrice:23e3,expectedIncrease:8.3,confidence:92,reasoning:"Giảm giá để tăng volume, margin vẫn tốt"},{product:"Mì tôm Hảo Hảo",currentPrice:5e3,optimizedPrice:5500,expectedIncrease:15.2,confidence:78,reasoning:"Sản phẩm thiết yếu, có thể tăng giá nhẹ"}])}},Z=async()=>{try{const e=await Fe.get("/ai/demand-forecasting");e.data.success&&C(e.data.data)}catch(e){const t=[],n=["Coca Cola","Bánh mì","Mì tôm","Cà phê","Nước suối"];for(let a=0;a<30;a++)n.forEach(e=>{t.push({date:s().add(a,"days").format("YYYY-MM-DD"),product:e,predicted_demand:Math.floor(100*Math.random())+50,confidence:.3*Math.random()+.7})});C(t)}},ee=async()=>{try{const e=await Fe.get("/ai/anomaly-detection");e.data.success&&z(e.data.data)}catch(e){z([{type:"sales_spike",description:"Doanh thu Coca Cola tăng đột biến 150% vào 14:30",severity:"medium",timestamp:"2024-03-15T14:30:00",confidence:95,action:"Kiểm tra stock, chuẩn bị nhập thêm"},{type:"inventory_anomaly",description:"Tồn kho Bánh mì giảm bất thường nhanh",severity:"high",timestamp:"2024-03-15T16:45:00",confidence:88,action:"Kiểm tra quy trình xuất kho"},{type:"customer_behavior",description:"Khách hàng VIP giảm tần suất mua hàng",severity:"low",timestamp:"2024-03-15T09:15:00",confidence:72,action:"Chương trình retention"}])}},te=async()=>{try{const e=await Fe.get("/ai/chatbot/metrics");e.data.success&&_(e.data.data)}catch(e){_({totalConversations:1247,successfulResolutions:1089,averageResponseTime:1.2,customerSatisfaction:4.6,topQuestions:["Giờ mở cửa","Sản phẩm có sẵn","Chính sách đổi trả","Chương trình khuyến mãi","Thông tin liên hệ"]})}},ne=async()=>{try{const e=await Fe.get("/ai/settings");e.data.success&&O(e.data.data)}catch(e){O({autoRecommendations:!0,priceOptimizationEnabled:!0,anomalyAlerts:!0,chatbotEnabled:!0,modelRetrainingFrequency:"weekly",confidenceThreshold:80})}},ae=async(e,t)=>{try{a(!0);(await Fe.post(`/ai/models/${e}/${t}`)).data.success&&(r.success(`${t} model ${e} thành công`),K())}catch(n){r.error(`Có lỗi xảy ra khi ${t} model`)}finally{a(!1)}},se=e=>{switch(e){case"active":return"green";case"training":return"blue";case"error":return"red";default:return"default"}};return k.filter(e=>"Coca Cola"===e.product),t.jsxs("div",{style:{padding:"24px"},children:[t.jsxs(c,{justify:"space-between",align:"middle",style:{marginBottom:24},children:[t.jsxs(l,{children:[t.jsxs(lt,{level:2,style:{margin:0},children:[t.jsx(D,{})," AI & Machine Learning"]}),t.jsx(dt,{type:"secondary",children:"Trí tuệ nhân tạo và học máy cho POS thông minh"})]}),t.jsx(l,{children:t.jsxs(h,{children:[t.jsx(u,{icon:t.jsx(Y,{}),onClick:()=>$(!0),children:"Cấu hình AI"}),t.jsx(u,{icon:t.jsx(J,{}),onClick:()=>V(!0),children:"Training Models"}),t.jsx(u,{type:"primary",icon:t.jsx(T,{}),onClick:q,loading:n,children:"Cập nhật"})]})})]}),t.jsxs(P,{defaultActiveKey:"overview",children:[t.jsx(ut,{tab:"Tổng quan AI",children:t.jsx(c,{gutter:[16,16],style:{marginBottom:24},children:t.jsx(l,{xs:24,children:t.jsx(d,{title:"Trạng thái Models AI",loading:n,children:t.jsx(c,{gutter:[16,16],children:Object.entries(m).map(([e,n])=>t.jsx(l,{xs:24,sm:12,lg:8,children:t.jsx(d,{size:"small",children:t.jsxs(h,{direction:"vertical",style:{width:"100%"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx(dt,{strong:!0,children:e.replace("_"," ").toUpperCase()}),t.jsx(M,{color:se(n.status),children:n.status})]}),t.jsx(v,{percent:n.accuracy,size:"small",format:e=>`${e}% accuracy`}),t.jsxs(dt,{type:"secondary",style:{fontSize:"12px"},children:["Trained: ",s(n.lastTrained).format("DD/MM/YYYY")]}),t.jsxs(h,{children:[t.jsx(u,{size:"small",icon:t.jsx(G,{}),onClick:()=>ae(e,"start"),disabled:"active"===n.status,children:"Start"}),t.jsx(u,{size:"small",icon:t.jsx(H,{}),onClick:()=>ae(e,"stop"),disabled:"active"!==n.status,children:"Stop"}),t.jsx(u,{size:"small",icon:t.jsx(T,{}),onClick:()=>ae(e,"retrain"),children:"Retrain"})]})]})})},e))})})})})},"overview"),t.jsx(ut,{tab:t.jsxs("span",{children:[t.jsx(A,{}),"Phân khúc khách hàng"]}),children:t.jsx(He,{})},"customer-segmentation"),t.jsx(ut,{tab:t.jsxs("span",{children:[t.jsx(L,{}),"Dự báo doanh thu"]}),children:t.jsx(et,{})},"sales-forecasting"),t.jsx(ut,{tab:t.jsxs("span",{children:[t.jsx(F,{}),"Gợi ý sản phẩm"]}),children:t.jsx(st,{})},"product-recommendation"),t.jsx(ut,{tab:t.jsxs("span",{children:[t.jsx(U,{}),"Tối ưu giá"]}),children:t.jsx(ct,{})},"price-optimization")]})]})}},Symbol.toStringTag,{value:"Module"}));export{pt as A,me as _,Me as c,Fe as e};
