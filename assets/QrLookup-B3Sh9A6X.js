import{j as e}from"./index-D0cJwDsb.js";import{h as U,r as m,L as k}from"./vendor-DD54NZMZ.js";import{c as C,e as S,r as A}from"./relativeTime-CBzUSEMY.js";import{S as B,T as Q,W as G,B as y,X as W,A as J,f as u,Y as V,z as l,Z as d,H,k as Z,l as ee,J as R,K as ne,N as re,y as i,_ as x,v as te,M as N,O as se,P as ae,Q as ce}from"./antd-pmzi8FkM.js";import"./utils-Db1EesZb.js";l.extend(A);l.locale("vi");const{Title:I,Text:t,Paragraph:ie}=Q,{Step:j}=V,xe=()=>{const{id:f}=U(),[$,b]=m.useState(!0),[Y,w]=m.useState(null),[h,D]=m.useState(null),[T,p]=m.useState(!1),[L,_]=m.useState(!1),[M,P]=m.useState(""),E=r=>{if(!r)return{status:"unknown",text:"Không xác định"};const s=l(),c=l(r).diff(s,"day");return c<0?{status:"expired",text:"Hết hạn",daysText:`Hết hạn ${Math.abs(c)} ngày trước`}:c<=30?{status:"expiring",text:"Sắp hết hạn",daysText:`Còn ${c} ngày`}:{status:"active",text:"Còn hiệu lực",daysText:`Còn ${c} ngày`}},K=r=>{switch(r){case"pending":return 0;case"processing":return 1;case"shipped":return 2;case"completed":return 3;case"cancelled":return-1;default:return 0}};m.useEffect(()=>{(async()=>{b(!0),w(null);try{const s=`order_qr_${f}`,o=await C.get(s);if(o){D(o),b(!1);return}const c=await S.get(`/customer/order/${f}`);C.set(s,c,300),D(c)}catch(s){console.error("Error fetching order data:",s),w(s.message||"Không thể tìm thấy thông tin đơn hàng. Mã QR không hợp lệ hoặc đã hết hạn.")}finally{b(!1)}})()},[f]);const F=async()=>{if(h){p(!0);try{await S.download(`/customer/invoice/${h.order.id}`,{},`hoa-don-${h.order.id}.pdf`)}catch(r){console.error("Error downloading invoice:",r),N.error({title:"Không thể tải hóa đơn",content:"Đã xảy ra lỗi khi tải hóa đơn. Vui lòng thử lại sau."})}finally{p(!1)}}},z=async()=>{if(h){p(!0);try{const r=await S.get(`/customer/invoice/${h.order.id}/preview`,{responseType:"blob"}),s=URL.createObjectURL(r);P(s),_(!0)}catch(r){console.error("Error previewing invoice:",r),N.error({title:"Không thể xem hóa đơn",content:"Đã xảy ra lỗi khi tải hóa đơn. Vui lòng thử lại sau."})}finally{p(!1)}}},O=[{title:"Sản phẩm",dataIndex:"name",key:"name",render:(r,s)=>e.jsxs("div",{children:[e.jsx(t,{strong:!0,children:r}),s.serial_number&&e.jsx("div",{children:e.jsxs(t,{type:"secondary",style:{fontSize:"12px"},children:["Mã SN: ",s.serial_number]})})]})},{title:"Giá",dataIndex:"price",key:"price",render:r=>new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(r)},{title:"SL",dataIndex:"quantity",key:"quantity",align:"center"},{title:"Thành tiền",dataIndex:"total",key:"total",render:(r,s)=>new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(s.price*s.quantity)},{title:"Bảo hành",dataIndex:"warranty_expiry",key:"warranty",render:(r,s)=>{if(!r)return e.jsx(t,{type:"secondary",children:"Không bảo hành"});const o=E(r);let c="green",v=e.jsx(se,{});return o.status==="expired"?(c="red",v=e.jsx(ae,{})):o.status==="expiring"&&(c="orange",v=e.jsx(ce,{})),e.jsxs("div",{children:[e.jsx(H,{color:c,icon:v,children:o.text}),e.jsx("div",{style:{marginTop:"4px"},children:e.jsx(t,{type:"secondary",style:{fontSize:"12px"},children:o.daysText})})]})}}];if($)return e.jsxs("div",{className:"text-center py-12",children:[e.jsx(B,{size:"large"}),e.jsx("div",{className:"mt-4",children:e.jsx(t,{type:"secondary",children:"Đang tải thông tin đơn hàng..."})})]});if(Y)return e.jsx(G,{status:"error",title:"Không tìm thấy thông tin đơn hàng",subTitle:Y,extra:[e.jsx(y,{type:"primary",children:e.jsx(k,{to:"/customer-lookup",children:"Tra cứu thủ công"})},"lookup")]});if(!h)return null;const{order:n,customer:g,products:X}=h,a=n.status||"pending",q=K(a);return e.jsxs("div",{children:[e.jsxs(I,{level:2,className:"text-center mb-6",children:[e.jsx(W,{})," Chi tiết đơn hàng"]}),a==="cancelled"?e.jsx(J,{message:"Đơn hàng đã bị hủy",description:"Đơn hàng này đã bị hủy và không còn hiệu lực.",type:"error",showIcon:!0,className:"mb-6"}):e.jsx(u,{className:"mb-6",children:e.jsxs(V,{current:q,status:a==="cancelled"?"error":"process",children:[e.jsx(j,{title:"Đặt hàng",description:l(n.created_at).format("DD/MM/YYYY")}),e.jsx(j,{title:"Xử lý",description:"Đang chuẩn bị hàng"}),e.jsx(j,{title:"Vận chuyển",description:n.shipped_at?l(n.shipped_at).format("DD/MM/YYYY"):"Chờ giao hàng"}),e.jsx(j,{title:"Hoàn thành",description:n.completed_at?l(n.completed_at).format("DD/MM/YYYY"):"Chờ hoàn thành"})]})}),e.jsxs(u,{className:"mb-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:justify-between md:items-start",children:[e.jsxs("div",{className:"mb-4 md:mb-0",children:[e.jsx(I,{level:4,children:"Thông tin đơn hàng"}),e.jsxs(d,{column:1,size:"small",children:[e.jsxs(d.Item,{label:"Mã đơn hàng",children:["#",n.id]}),e.jsx(d.Item,{label:"Ngày đặt",children:l(n.created_at).format("DD/MM/YYYY HH:mm")}),e.jsx(d.Item,{label:"Trạng thái",children:e.jsx(H,{color:a==="completed"?"green":a==="cancelled"?"red":a==="shipped"?"blue":"orange",children:a==="completed"?"Hoàn thành":a==="cancelled"?"Đã hủy":a==="shipped"?"Đang giao hàng":a==="processing"?"Đang xử lý":"Chờ xác nhận"})}),e.jsx(d.Item,{label:"Phương thức thanh toán",children:n.payment_method||"Tiền mặt"})]})]}),e.jsxs("div",{children:[e.jsx(I,{level:4,children:"Thông tin khách hàng"}),e.jsxs(d,{column:1,size:"small",children:[e.jsx(d.Item,{label:"Họ tên",children:g.name}),e.jsx(d.Item,{label:"Số điện thoại",children:g.phone}),g.email&&e.jsx(d.Item,{label:"Email",children:g.email}),n.shipping_address&&e.jsx(d.Item,{label:"Địa chỉ giao hàng",children:n.shipping_address})]})]})]}),e.jsx(Z,{}),e.jsxs(ee,{className:"mb-4",children:[e.jsx(R,{title:"Xem hóa đơn",children:e.jsx(y,{icon:e.jsx(ne,{}),onClick:z,loading:T,children:"Xem hóa đơn"})}),e.jsx(R,{title:"Tải hóa đơn",children:e.jsx(y,{icon:e.jsx(re,{}),onClick:F,loading:T,children:"Tải hóa đơn"})})]})]}),e.jsx(u,{title:"Danh sách sản phẩm",className:"mb-6",children:e.jsx(i,{columns:O,dataSource:X.map(r=>({...r,key:r.id})),pagination:!1,summary:r=>{let s=0;return r.forEach(({price:o,quantity:c})=>{s+=o*c}),e.jsxs(e.Fragment,{children:[e.jsxs(i.Summary.Row,{children:[e.jsx(i.Summary.Cell,{index:0,colSpan:3,children:e.jsx(t,{strong:!0,children:"Tổng tiền sản phẩm"})}),e.jsx(i.Summary.Cell,{index:1,colSpan:2,children:e.jsx(t,{strong:!0,children:new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(s)})})]}),n.shipping_fee>0&&e.jsxs(i.Summary.Row,{children:[e.jsx(i.Summary.Cell,{index:0,colSpan:3,children:e.jsx(t,{children:"Phí vận chuyển"})}),e.jsx(i.Summary.Cell,{index:1,colSpan:2,children:new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(n.shipping_fee||0)})]}),n.discount>0&&e.jsxs(i.Summary.Row,{children:[e.jsx(i.Summary.Cell,{index:0,colSpan:3,children:e.jsx(t,{children:"Giảm giá"})}),e.jsxs(i.Summary.Cell,{index:1,colSpan:2,children:["- ",new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(n.discount||0)]})]}),e.jsxs(i.Summary.Row,{children:[e.jsx(i.Summary.Cell,{index:0,colSpan:3,children:e.jsx(t,{strong:!0,children:"Tổng thanh toán"})}),e.jsx(i.Summary.Cell,{index:1,colSpan:2,children:e.jsx(t,{strong:!0,style:{fontSize:"16px",color:"#f5222d"},children:new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(n.total)})})]})]})}})}),e.jsx(u,{title:"Lịch sử đơn hàng",className:"mb-6",children:e.jsxs(x,{mode:"left",children:[e.jsxs(x.Item,{color:"green",label:l(n.created_at).format("DD/MM/YYYY HH:mm"),children:[e.jsx(t,{strong:!0,children:"Đơn hàng được tạo"}),e.jsx("br",{}),e.jsx(t,{type:"secondary",children:"Đơn hàng của bạn đã được tiếp nhận"})]}),a!=="pending"&&e.jsxs(x.Item,{color:"blue",label:l(n.processing_at||n.created_at).add(1,"hour").format("DD/MM/YYYY HH:mm"),children:[e.jsx(t,{strong:!0,children:"Đang xử lý"}),e.jsx("br",{}),e.jsx(t,{type:"secondary",children:"Đơn hàng đang được chuẩn bị"})]}),(a==="shipped"||a==="completed")&&e.jsxs(x.Item,{color:"blue",label:l(n.shipped_at||n.created_at).add(1,"day").format("DD/MM/YYYY HH:mm"),children:[e.jsx(t,{strong:!0,children:"Đang giao hàng"}),e.jsx("br",{}),e.jsx(t,{type:"secondary",children:"Đơn hàng đang được vận chuyển đến bạn"})]}),a==="completed"&&e.jsxs(x.Item,{color:"green",label:l(n.completed_at||n.created_at).add(2,"day").format("DD/MM/YYYY HH:mm"),children:[e.jsx(t,{strong:!0,children:"Hoàn thành"}),e.jsx("br",{}),e.jsx(t,{type:"secondary",children:"Đơn hàng đã được giao thành công"})]}),a==="cancelled"&&e.jsxs(x.Item,{color:"red",label:l(n.cancelled_at||n.created_at).add(1,"hour").format("DD/MM/YYYY HH:mm"),children:[e.jsx(t,{strong:!0,children:"Đã hủy"}),e.jsx("br",{}),e.jsx(t,{type:"secondary",children:"Đơn hàng đã bị hủy"})]})]})}),e.jsxs(u,{title:"Hỗ trợ",className:"mb-6",children:[e.jsx(ie,{children:"Nếu bạn có bất kỳ thắc mắc nào về đơn hàng, vui lòng liên hệ với chúng tôi:"}),e.jsxs("ul",{className:"list-none pl-0",children:[e.jsxs("li",{className:"mb-2",children:[e.jsx(te,{className:"mr-2"})," Hotline: ",e.jsx(t,{strong:!0,children:"1900 1234"})," (8:00 - 21:00, cả T7 & CN)"]}),e.jsx("li",{children:e.jsxs(t,{type:"secondary",children:["Khi liên hệ, vui lòng cung cấp mã đơn hàng: ",e.jsxs(t,{strong:!0,children:["#",n.id]})]})})]})]}),e.jsx("div",{className:"text-center",children:e.jsx(y,{type:"primary",children:e.jsx(k,{to:"/customer-lookup",children:"Tra cứu đơn hàng khác"})})}),e.jsx(N,{visible:L,title:"Xem hóa đơn",footer:null,onCancel:()=>{_(!1),URL.revokeObjectURL(M)},width:800,children:e.jsx("iframe",{src:M,style:{width:"100%",height:"70vh"},title:"Invoice Preview"})})]})};export{xe as default};
