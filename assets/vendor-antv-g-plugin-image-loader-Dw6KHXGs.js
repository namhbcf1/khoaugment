import{_ as e,a as t,b as n,c as a,n as r,p as i,o,h as c}from"./polyfills-BjGv5uaK.js";import{k as u,z as s,D as l,B as h,x as g,F as d,J as f,U as v,E as m,S as p,O as y}from"./vendor-antv-g-lite-BsxRpwbw.js";import{c as S}from"./vendor-antv-util-BIOdtugi.js";import{P as k,e as w,ar as I}from"./vendor-gl-matrix-DC4KmxQg.js";
/*!
 * @antv/g-plugin-image-loader
 * @description A G plugin for loading image
 * @version 2.1.23
 * @date 5/30/2025, 2:54:46 AM
 * @author AntVis
 * @docs https://g.antv.antgroup.com/
 */var x=function(){return t(function e(){n(this,e),this.cacheStore=new Map},[{key:"onRefAdded",value:function(e){}},{key:"has",value:function(e){return this.cacheStore.has(e)}},{key:"put",value:function(e,t,n){return!this.cacheStore.has(e)&&(this.cacheStore.set(e,{value:t,counter:new Set([n.entity])}),this.onRefAdded(n),!0)}},{key:"get",value:function(e,t){var n=this.cacheStore.get(e);return n?(n.counter.has(t.entity)||(n.counter.add(t.entity),this.onRefAdded(t)),n.value):null}},{key:"update",value:function(e,t,n){var a=this.cacheStore.get(e);return!!a&&(a.value=i(i({},a.value),t),a.counter.has(n.entity)||(a.counter.add(n.entity),this.onRefAdded(n)),!0)}},{key:"release",value:function(e,t){var n=this.cacheStore.get(e);return!!n&&(n.counter.delete(t.entity),n.counter.size<=0&&this.cacheStore.delete(e),!0)}},{key:"releaseRef",value:function(e){var t=this;Array.from(this.cacheStore.keys()).forEach(function(n){t.release(n,e)})}},{key:"getSize",value:function(){return this.cacheStore.size}},{key:"clear",value:function(){this.cacheStore.clear()}}])}(),A=[],R=[],z=function(){function e(){n(this,e)}return t(e,null,[{key:"stop",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.api;e.rafId&&(t.cancelAnimationFrame(e.rafId),e.rafId=null)}},{key:"executeTask",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.api;A.length<=0&&R.length<=0||(R.forEach(function(e){return e()}),R=A.splice(0,e.TASK_NUM_PER_FRAME),e.rafId=t.requestAnimationFrame(function(){e.executeTask(t)}))}},{key:"sliceImage",value:function(t,n,a,r){for(var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:e.api,c=t.naturalWidth||t.width,u=t.naturalHeight||t.height,s=n-i,l=a-i,h=Math.ceil(c/s),g=Math.ceil(u/l),d={tileSize:[n,a],gridSize:[g,h],tiles:Array(g).fill(null).map(function(){return Array(h).fill(null)})},f=function(e){for(var i=function(i){A.push(function(){var h=i*s,g=e*l,f=[Math.min(n,c-h),Math.min(a,u-g)],v=f[0],m=f[1],p=o.createCanvas();p.width=n,p.height=a,p.getContext("2d").drawImage(t,h,g,v,m,0,0,v,m),d.tiles[e][i]={x:h,y:g,tileX:i,tileY:e,data:p},r()})},g=0;g<h;g++)i(g)},v=0;v<g;v++)f(v);return e.stop(),e.executeTask(),d}}])}();z.TASK_NUM_PER_FRAME=10;var C=new x;C.onRefAdded=function(e){var t=this;e.addEventListener(m.DESTROY,function(){t.releaseRef(e)},{once:!0})};var E=function(){return t(function e(t,a){n(this,e),this.gradientCache={},this.patternCache={},this.context=t,this.runtime=a},[{key:"getImageSync",value:function(e,t,n){var a=S(e)?e:e.src;if(C.has(a)){var r=C.get(a,t);if(r.img.complete)return null==n||n(r),r}return this.getOrCreateImage(e,t).then(function(e){null==n||n(e)}).catch(function(e){}),null}},{key:"getOrCreateImage",value:function(e,t){var n=this,a=S(e)?e:e.src;if(!S(e)&&!C.has(a)){var r={img:e,size:[e.naturalWidth||e.width,e.naturalHeight||e.height],tileSize:M(e)};C.put(a,r,t)}if(C.has(a)){var i=C.get(a,t);return i.img.complete?Promise.resolve(i):new Promise(function(e,t){i.img.addEventListener("load",function(){i.size=[i.img.naturalWidth||i.img.width,i.img.naturalHeight||i.img.height],i.tileSize=M(i.img),e(i)}),i.img.addEventListener("error",function(e){t(e)})})}return new Promise(function(e,r){var i=n.context.config.createImage();if(i){var o={img:i,size:[0,0],tileSize:M(i)};C.put(a,o,t),i.onload=function(){o.size=[i.naturalWidth||i.width,i.naturalHeight||i.height],o.tileSize=M(o.img),e(o)},i.onerror=function(e){r(e)},i.crossOrigin="Anonymous",i.src=a}})}},{key:"createDownSampledImage",value:(a=r(o().mark(function e(t,n){var a,r,u,s,l,h,g,d,f,v,m,p,y,S;return o().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getOrCreateImage(t,n);case 2:if(void 0===(a=e.sent).downSamplingRate){e.next=5;break}return e.abrupt("return",a);case 5:if(r=this.context.config.enableLargeImageOptimization,s=(u="boolean"==typeof r?{}:r).maxDownSampledImageSize,l=void 0===s?2048:s,h=u.downSamplingRateThreshold,g=void 0===h?.5:h,d=this.runtime.globalThis.createImageBitmap,f=c(a.size,2),v=f[0],m=f[1],p=a.img,y=Math.min((l+l)/(v+m),Math.max(.01,Math.min(g,.5))),S=i(i({},a),{},{downSamplingRate:y}),C.update(a.img.src,S,n),!d){e.next=25;break}return e.prev=14,e.next=17,d(a.img,{resizeWidth:v*y,resizeHeight:m*y});case 17:p=e.sent,e.next=23;break;case 20:e.prev=20,e.t0=e.catch(14),y=1;case 23:e.next=26;break;case 25:y=1;case 26:return S=i(i({},this.getImageSync(t,n)),{},{downSampled:p,downSamplingRate:y}),C.update(a.img.src,S,n),e.abrupt("return",S);case 29:case"end":return e.stop()}},e,this,[[14,20]])})),function(e,t){return a.apply(this,arguments)})},{key:"createImageTiles",value:(e=r(o().mark(function e(t,n,a,r){var c,u,s,l,h;return o().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getOrCreateImage(t,r);case 2:return c=e.sent,u=r.ownerDocument.defaultView,s=u.requestAnimationFrame,l=u.cancelAnimationFrame,z.api={requestAnimationFrame:s,cancelAnimationFrame:l,createCanvas:function(){return y.createCanvas()}},h=i(i({},c),z.sliceImage(c.img,c.tileSize[0],c.tileSize[0],a)),C.update(c.img.src,h,r),e.abrupt("return",h);case 8:case"end":return e.stop()}},e,this)})),function(t,n,a,r){return e.apply(this,arguments)})},{key:"releaseImage",value:function(e,t){C.release(S(e)?e:e.src,t)}},{key:"releaseImageRef",value:function(e){C.releaseRef(e)}},{key:"getOrCreatePatternSync",value:function(e,t,n,a,r,i,o){var c=this.generatePatternKey(t);if(c&&this.patternCache[c])return this.patternCache[c];var u,g=t.image,d=t.repetition,f=t.transform,v=!1;if(S(g)){var m=this.getImageSync(g,e,o);u=null==m?void 0:m.img}else a?(u=a,v=!0):u=g;var p,y=u&&n.createPattern(u,d);y&&(p=f?s(h(f),new l({})):k(w()),v&&I(p,p,[1/r,1/r,1]),y.setTransform({a:p[0],b:p[1],c:p[4],d:p[5],e:p[12]+i[0],f:p[13]+i[1]}));return c&&y&&(this.patternCache[c]=y),y}},{key:"getOrCreateGradient",value:function(e,t){var n=this.generateGradientKey(e),a=e.type,r=e.steps,i=e.min,o=e.width,c=e.height,u=e.angle,s=e.cx,l=e.cy,h=e.size;if(this.gradientCache[n])return this.gradientCache[n];var m=null;if(a===g.LinearGradient){var p=d(i,o,c,u),y=p.x1,S=p.y1,k=p.x2,w=p.y2;m=t.createLinearGradient(y,S,k,w)}else if(a===g.RadialGradient){var I=f(i,o,c,s,l,h),x=I.x,A=I.y,R=I.r;m=t.createRadialGradient(x,A,0,x,A,R)}return m&&(r.forEach(function(e){var t,n=e.offset,a=e.color;n.unit===v.kPercentage&&(null===(t=m)||void 0===t||t.addColorStop(n.value/100,a.toString()))}),this.gradientCache[n]=m),this.gradientCache[n]}},{key:"generateGradientKey",value:function(e){var t=e.type,n=e.min,a=e.width,r=e.height,i=e.steps,o=e.angle,c=e.cx,u=e.cy,s=e.size;return"gradient-".concat(t,"-").concat((null==o?void 0:o.toString())||0,"-").concat((null==c?void 0:c.toString())||0,"-").concat((null==u?void 0:u.toString())||0,"-").concat((null==s?void 0:s.toString())||0,"-").concat(n[0],"-").concat(n[1],"-").concat(a,"-").concat(r,"-").concat(i.map(function(e){var t=e.offset,n=e.color;return"".concat(t).concat(n)}).join("-"))}},{key:"generatePatternKey",value:function(e){var t=e.image,n=e.repetition;return S(t)?"pattern-".concat(t,"-").concat(n):"rect"===t.nodeName?"pattern-".concat(t.entity,"-").concat(n):void 0}}]);var e,a}();function M(e){if(!e.complete)return[0,0];var t=e.naturalWidth||e.width,n=e.naturalHeight||e.height,a=256;return[256,512].forEach(function(e){Math.ceil(n/e)*Math.ceil(t/e)<1e3&&(a=e)}),[a,a]}E.isSupportTile=!!y.createCanvas();var b=function(){function e(){n(this,e)}return t(e,[{key:"apply",value:function(t){var n=t.renderingService,a=t.renderingContext,r=t.imagePool,i=a.root.ownerDocument.defaultView,o=function(e,t,n){var a=e.parsedStyle,r=a.width,i=a.height;r&&!i?e.setAttribute("height",n/t*r):!r&&i&&e.setAttribute("width",t/n*i)},c=function(e){var t=e.target,a=t.nodeName,i=t.attributes;if(a===p.IMAGE){var c=i.src,u=i.keepAspectRatio;r.getImageSync(c,t,function(e){var a=e.img,r=a.width,i=a.height;u&&o(t,r,i),t.renderable.dirty=!0,n.dirtify()})}},u=function(e){var t=e.target,a=e.attrName,i=e.prevValue,c=e.newValue;t.nodeName===p.IMAGE&&"src"===a&&(i!==c&&r.releaseImage(i,t),S(c)&&r.getOrCreateImage(c,t).then(function(e){var a=e.img,r=a.width,i=a.height;t.attributes.keepAspectRatio&&o(t,r,i),t.renderable.dirty=!0,n.dirtify()}).catch(function(){}))};n.hooks.init.tap(e.tag,function(){i.addEventListener(m.MOUNTED,c),i.addEventListener(m.ATTR_MODIFIED,u)}),n.hooks.destroy.tap(e.tag,function(){i.removeEventListener(m.MOUNTED,c),i.removeEventListener(m.ATTR_MODIFIED,u)})}}])}();b.tag="LoadImage";var T=function(){function r(){var e;n(this,r);for(var t=arguments.length,i=new Array(t),o=0;o<t;o++)i[o]=arguments[o];return(e=a(this,r,[].concat(i))).name="image-loader",e}return e(r,u),t(r,[{key:"init",value:function(e){this.context.imagePool=new E(this.context,e),this.addRenderingPlugin(new b)}},{key:"destroy",value:function(){this.removeAllRenderingPlugins()}}])}();export{E as I,T as P};
