import{a as W}from"./utils-Db1EesZb.js";import{_ as Q}from"./index-DPVYnWcF.js";import{e as A,g as q}from"./vendor-DD54NZMZ.js";import{bO as X}from"./antd-pmzi8FkM.js";const N="auth_token",Y="refresh_token",F="user_info",H="token_expiry",G=(e,t,n=3600)=>{localStorage.setItem(N,e),localStorage.setItem(Y,t);const r=Date.now()+n*1e3;localStorage.setItem(H,r.toString())},Z=()=>localStorage.getItem(N),ee=()=>localStorage.getItem(Y),U=()=>{localStorage.removeItem(N),localStorage.removeItem(Y),localStorage.removeItem(F),localStorage.removeItem(H)},te=async()=>{const e=ee();if(!e)return null;try{const{apiClient:t}=await Q(async()=>{const{apiClient:r}=await Promise.resolve().then(()=>we);return{apiClient:r}},void 0),n=await t.post("/auth/refresh",{refreshToken:e},{headers:{"X-Skip-Auth":"true"}});return n.data&&n.data.accessToken?(G(n.data.accessToken,n.data.refreshToken||e,n.data.expiresIn||3600),n.data.user&&ne(n.data.user),n.data.accessToken):null}catch(t){return console.error("Failed to refresh token:",t),U(),null}},ne=e=>{localStorage.setItem(F,JSON.stringify(e))};class re{constructor(){this.cache=new Map,this.ttls=new Map,this.cleanupInterval=setInterval(()=>this.cleanup(),60*1e3)}set(t,n,r=0){if(this.cache.set(t,n),r>0){const s=Date.now()+r*1e3;this.ttls.set(t,s)}else this.ttls.delete(t)}get(t){if(this.isExpired(t)){this.delete(t);return}return this.cache.get(t)}delete(t){this.cache.delete(t),this.ttls.delete(t)}clear(){this.cache.clear(),this.ttls.clear()}has(t){return this.cache.has(t)?this.isExpired(t)?(this.delete(t),!1):!0:!1}isExpired(t){const n=this.ttls.get(t);return n?Date.now()>n:!1}cleanup(){for(const[t,n]of this.ttls.entries())Date.now()>n&&this.delete(t)}keys(){return Array.from(this.cache.keys()).filter(t=>!this.isExpired(t))}destroy(){clearInterval(this.cleanupInterval),this.clear()}}const g=new re;class se{constructor(t="posAppCache",n="cache",r=1){this.dbName=t,this.storeName=n,this.version=r,this.db=null,this.isInitialized=!1,this.init()}async init(){if(!window.indexedDB){console.warn("IndexedDB not supported");return}try{const t=indexedDB.open(this.dbName,this.version);t.onupgradeneeded=n=>{const r=n.target.result;r.objectStoreNames.contains(this.storeName)||r.createObjectStore(this.storeName,{keyPath:"key"}).createIndex("expiry","expiry",{unique:!1})},this.db=await new Promise((n,r)=>{t.onsuccess=s=>{n(s.target.result)},t.onerror=s=>{console.error("IndexedDB error:",s.target.error),r(s.target.error)}}),this.isInitialized=!0,this.scheduleCleanup()}catch(t){console.error("Failed to initialize IndexedDB cache:",t)}}async ensureInitialized(){return this.isInitialized?this.db:(await new Promise(t=>{const n=()=>{this.isInitialized?t():setTimeout(n,100)};n()}),this.db)}async set(t,n,r=0){try{const s=await this.ensureInitialized();if(!s)return;const o=r>0?Date.now()+r*1e3:0,a=s.transaction([this.storeName],"readwrite"),c=a.objectStore(this.storeName);await new Promise((d,i)=>{const l=c.put({key:t,value:n,expiry:o,created:Date.now()});l.onsuccess=()=>d(),l.onerror=f=>i(f.target.error),a.oncomplete=()=>d(),a.onerror=f=>i(f.target.error)})}catch(s){console.error("Failed to set item in IndexedDB cache:",s)}}async get(t){try{const n=await this.ensureInitialized();if(!n)return;const s=n.transaction([this.storeName],"readonly").objectStore(this.storeName);return await new Promise((a,c)=>{const d=s.get(t);d.onsuccess=i=>{const l=i.target.result;if(!l){a(void 0);return}l.expiry>0&&Date.now()>l.expiry?(this.delete(t).catch(console.error),a(void 0)):a(l.value)},d.onerror=i=>{console.error("Error getting cached item:",i.target.error),c(i.target.error)}})}catch(n){console.error("Failed to get item from IndexedDB cache:",n);return}}async delete(t){try{const n=await this.ensureInitialized();if(!n)return;const s=n.transaction([this.storeName],"readwrite").objectStore(this.storeName);await new Promise((o,a)=>{const c=s.delete(t);c.onsuccess=()=>o(),c.onerror=d=>a(d.target.error)})}catch(n){console.error("Failed to delete item from IndexedDB cache:",n)}}async clear(){try{const t=await this.ensureInitialized();if(!t)return;const r=t.transaction([this.storeName],"readwrite").objectStore(this.storeName);await new Promise((s,o)=>{const a=r.clear();a.onsuccess=()=>s(),a.onerror=c=>o(c.target.error)})}catch(t){console.error("Failed to clear IndexedDB cache:",t)}}async has(t){try{return await this.get(t)!==void 0}catch(n){return console.error("Failed to check key in IndexedDB cache:",n),!1}}async keys(){try{const t=await this.ensureInitialized();if(!t)return[];const r=t.transaction([this.storeName],"readonly").objectStore(this.storeName);return new Promise((s,o)=>{const a=r.getAllKeys();a.onsuccess=()=>s(a.result),a.onerror=c=>o(c.target.error)})}catch(t){return console.error("Failed to get keys from IndexedDB cache:",t),[]}}scheduleCleanup(){setInterval(()=>this.cleanup(),60*60*1e3)}async cleanup(){try{const t=await this.ensureInitialized();if(!t)return;const n=Date.now(),o=t.transaction([this.storeName],"readwrite").objectStore(this.storeName).index("expiry"),a=IDBKeyRange.bound(1,n);await new Promise((c,d)=>{const i=o.openCursor(a);i.onsuccess=l=>{const f=l.target.result;f?(f.delete(),f.continue()):c()},i.onerror=l=>d(l.target.error)}),console.log("IndexedDB cache cleanup completed")}catch(t){console.error("Failed to cleanup IndexedDB cache:",t)}}}const T=new se,be={set:(e,t,n=0,r=!0)=>{g.set(e,t,n),r&&T.set(e,t,n).catch(console.error)},get:async e=>{const t=g.get(e);if(t!==void 0)return t;const n=await T.get(e);return n!==void 0&&g.set(e,n,0),n},delete:e=>{g.delete(e),T.delete(e).catch(console.error)},clear:()=>{g.clear(),T.clear().catch(console.error)},has:async e=>g.has(e)?!0:await T.has(e)},$={enabled:!0,consoleLog:!1,endpointUrl:"/api/analytics",bufferSize:10,flushInterval:3e4,samplingRate:1,includePerformance:!0,anonymizeIp:!0,offlineStorage:!0,appVersion:"1.0.0"};let h={...$},p=[],m={},B=!1,x=J(),z=0;const ae=(e={})=>{B||(h={...$,...e},ie(),h.flushInterval>0&&setInterval(()=>L(),h.flushInterval),h.includePerformance&&ce(),document.addEventListener("visibilitychange",le),window.addEventListener("online",de),window.addEventListener("offline",ue),oe(),B=!0)},y=(e,t={},n=!1)=>{if(!h.enabled||Math.random()>h.samplingRate)return;const r={eventName:e,eventData:t,timestamp:Date.now(),sessionId:x,url:window.location.href,referrer:document.referrer||"",userAgent:navigator.userAgent,screenSize:`${window.innerWidth}x${window.innerHeight}`,appVersion:h.appVersion};h.includePerformance&&(r.performance={...m}),h.consoleLog&&console.log(`Analytics Event: ${e}`,r),n?fe(r):(p.push(r),p.length>=h.bufferSize&&L())},oe=(e=null,t=null)=>{z++,y("page_view",{path:e||window.location.pathname,title:t||document.title,viewNumber:z})},L=async()=>{if(!p.length)return!0;try{const e=[...p];return p=[],!navigator.onLine&&h.offlineStorage?(R(e),!1):(await P(e),!0)}catch(e){return console.error("Failed to flush analytics events:",e),h.offlineStorage?(R(p),p=[],!1):(p=[...p,...events],!1)}};function J(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function ie(){const e=sessionStorage.getItem("analytics_session_id"),t=parseInt(sessionStorage.getItem("analytics_session_timestamp")||"0"),n=Date.now();e&&n-t<30*60*1e3?x=e:(x=J(),sessionStorage.setItem("analytics_session_id",x)),sessionStorage.setItem("analytics_session_timestamp",n.toString())}function ce(){try{const e=performance.getEntriesByType("navigation")[0],t=performance.getEntriesByType("paint");e&&(m.loadTime=e.loadEventEnd-e.startTime,m.domContentLoaded=e.domContentLoadedEventEnd-e.startTime,m.timeToFirstByte=e.responseStart-e.requestStart,m.domInteractive=e.domInteractive-e.startTime);const n=t.find(s=>s.name==="first-paint");n&&(m.firstPaint=n.startTime);const r=t.find(s=>s.name==="first-contentful-paint");if(r&&(m.firstContentfulPaint=r.startTime),performance.memory&&(m.jsHeapSizeLimit=performance.memory.jsHeapSizeLimit,m.totalJSHeapSize=performance.memory.totalJSHeapSize,m.usedJSHeapSize=performance.memory.usedJSHeapSize),y("performance",m),"PerformanceObserver"in window)try{new PerformanceObserver(o=>{o.getEntries().forEach(a=>{a.duration>50&&y("long_task",{duration:a.duration,name:a.name,startTime:a.startTime})})}).observe({entryTypes:["longtask"]})}catch(s){console.error("Long task tracking not supported:",s)}}catch(e){console.error("Error tracking performance:",e)}}function le(e){if(document.visibilityState==="hidden"){const t=Date.now()-m.pageVisibleTime;y("visibility_change",{state:"hidden",visibleTime:t},!0),L()}else document.visibilityState==="visible"&&(m.pageVisibleTime=Date.now(),y("visibility_change",{state:"visible"}))}function de(){he(),y("connectivity_change",{state:"online"})}function ue(){y("connectivity_change",{state:"offline"},!0)}function R(e){if(e.length)try{const r=[...JSON.parse(localStorage.getItem("offline_analytics_events")||"[]"),...e].slice(-100);localStorage.setItem("offline_analytics_events",JSON.stringify(r))}catch(t){console.error("Failed to store offline events:",t)}}async function he(){try{const e=JSON.parse(localStorage.getItem("offline_analytics_events")||"[]");if(e.length===0)return;localStorage.removeItem("offline_analytics_events"),await P(e)}catch(e){console.error("Failed to process offline events:",e)}}async function fe(e){await P([e])}async function P(e){if(!(!e.length||!h.endpointUrl))try{if(navigator.sendBeacon){const t=new Blob([JSON.stringify({events:e})],{type:"application/json"});if(navigator.sendBeacon(h.endpointUrl,t))return}await fetch(h.endpointUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({events:e}),keepalive:!0})}catch(t){throw console.error("Failed to send analytics events:",t),t}}typeof window<"u"&&ae();const me=15e3,j=1e3,u=W.create({baseURL:"/api",timeout:me,headers:{"Content-Type":"application/json","X-Client-Version":"1.0.0"}});u.interceptors.request.use(async e=>{if(e.url&&(e.url.includes("/auth/login")||e.url.includes("/auth/refresh")))return e;const t=Z();return t&&(e.headers.Authorization=`Bearer ${t}`),e.metadata={startTime:Date.now()},e.headers["X-Offline-Operation"]=navigator.onLine?"false":"true",e},e=>Promise.reject(e));u.interceptors.response.use(e=>{if(e.config.metadata){const t=Date.now()-e.config.metadata.startTime;e.duration=t,t>1e3&&(console.warn(`Slow API request: ${e.config.url} took ${t}ms`),y("api_performance",{endpoint:e.config.url,duration:t,status:e.status}))}return e},async e=>{const t=e.config;if(!e.response&&e.message==="Network Error"){await pe(t);const r=await ge(t);return r?Promise.resolve({...r,isOfflineCache:!0}):Promise.reject({...e,isOfflineError:!0,message:"You are currently offline. This operation will sync when you're back online."})}if(e.response&&e.response.status===401&&!t._retry){t._retry=!0;try{const r=await te();if(r)return t.headers.Authorization=`Bearer ${r}`,u(t)}catch(r){return U(),window.location.href="/login?session_expired=true",Promise.reject(r)}}if(e.response&&e.response.status===429&&!t._rateLimit){const r=e.response.headers["retry-after"]?parseInt(e.response.headers["retry-after"])*1e3:j;return t._rateLimit=!0,await new Promise(s=>setTimeout(s,r)),u(t)}if(e.response&&e.response.status>=500&&!t._serverRetry)return t._serverRetry=!0,await new Promise(r=>setTimeout(r,j)),u(t);const n={status:e.response?e.response.status:0,message:e.response&&e.response.data.message||e.message,data:e.response?e.response.data:null,originalError:e};return y("api_error",{endpoint:t.url,method:t.method,status:n.status,message:n.message}),Promise.reject(n)});async function pe(e){if(!("serviceWorker"in navigator)||!navigator.serviceWorker.controller){const t=JSON.parse(localStorage.getItem("offlineApiQueue")||"[]");t.push({url:e.url,method:e.method,data:e.data,headers:e.headers,timestamp:Date.now()}),localStorage.setItem("offlineApiQueue",JSON.stringify(t));return}try{await navigator.serviceWorker.ready,await navigator.serviceWorker.controller.postMessage({type:"ENQUEUE_REQUEST",payload:{url:e.url,method:e.method,data:e.data,headers:e.headers,timestamp:Date.now()}})}catch(t){console.error("Failed to queue offline request:",t)}}async function ge(e){const t=`api_cache_${e.url}_${JSON.stringify(e.params||{})}`,n=g.get(t);if(n)return n;if("serviceWorker"in navigator&&navigator.serviceWorker.controller)try{await navigator.serviceWorker.ready;const r=await new Promise(s=>{const o=new MessageChannel;o.port1.onmessage=a=>s(a.data),navigator.serviceWorker.controller.postMessage({type:"GET_CACHED_RESPONSE",payload:{url:e.url,params:e.params}},[o.port2])});if(r&&r.data)return r.data}catch(r){console.error("Failed to get cached response:",r)}return null}const ye={async get(e,t={}){return(await u.get(e,t)).data},async post(e,t={},n={}){return(await u.post(e,t,n)).data},async put(e,t={},n={}){return(await u.put(e,t,n)).data},async patch(e,t={},n={}){return(await u.patch(e,t,n)).data},async delete(e,t={}){return(await u.delete(e,t)).data},async getCached(e,t={},n=300){const r=`api_cache_${e}_${JSON.stringify(t.params||{})}`,s=g.get(r);if(s)return s;const o=await u.get(e,t);return g.set(r,o.data,n),o.data},async upload(e,t,n=null,r={}){const s={...r,headers:{...r.headers,"Content-Type":"multipart/form-data"}};return n&&(s.onUploadProgress=a=>{const c=Math.round(a.loaded*100/a.total);n(c,a)}),(await u.post(e,t,s)).data},async download(e,t={},n=null,r=null){const s={params:t,responseType:"blob",headers:{Accept:"application/octet-stream"}};r&&(s.onDownloadProgress=a=>{const c=Math.round(a.loaded*100/a.total);r(c,a)});const o=await u.get(e,s);if(n){const a=new Blob([o.data]),c=window.URL.createObjectURL(a),d=document.createElement("a");d.href=c,d.download=n,document.body.appendChild(d),d.click(),d.remove(),window.URL.revokeObjectURL(c)}return o.data},async batch(e){return(await Promise.allSettled(e.map(n=>{const r=(n.method||"get").toLowerCase();return u[r](n.url,n.data,n.config)}))).map(n=>n.status==="fulfilled"?{success:!0,data:n.value.data}:{success:!1,error:{status:n.reason.response?.status,message:n.reason.response?.data?.message||n.reason.message}})},async healthCheck(){try{return(await u.get("/health",{timeout:5e3})).status===200}catch{return!1}},getClient(){return u}};window.addEventListener("online",async()=>{const e=JSON.parse(localStorage.getItem("offlineApiQueue")||"[]");if(e.length>0){console.log(`Processing ${e.length} offline requests`);for(const t of e)try{await u({url:t.url,method:t.method,data:t.data,headers:t.headers})}catch(n){console.error("Failed to process offline request:",n)}localStorage.removeItem("offlineApiQueue")}console.log("Back online. Synced offline changes.")});window.addEventListener("offline",()=>{console.log("You are offline. Changes will be saved and synced when you reconnect.")});const we=Object.freeze(Object.defineProperty({__proto__:null,api:ye,apiClient:u},Symbol.toStringTag,{value:"Module"}));var ve={exports:{}};(function(e,t){(function(n,r){e.exports=r(X)})(A,function(n){function r(a){return a&&typeof a=="object"&&"default"in a?a:{default:a}}var s=r(n),o={name:"vi",weekdays:"chủ nhật_thứ hai_thứ ba_thứ tư_thứ năm_thứ sáu_thứ bảy".split("_"),months:"tháng 1_tháng 2_tháng 3_tháng 4_tháng 5_tháng 6_tháng 7_tháng 8_tháng 9_tháng 10_tháng 11_tháng 12".split("_"),weekStart:1,weekdaysShort:"CN_T2_T3_T4_T5_T6_T7".split("_"),monthsShort:"Th01_Th02_Th03_Th04_Th05_Th06_Th07_Th08_Th09_Th10_Th11_Th12".split("_"),weekdaysMin:"CN_T2_T3_T4_T5_T6_T7".split("_"),ordinal:function(a){return a},formats:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM [năm] YYYY",LLL:"D MMMM [năm] YYYY HH:mm",LLLL:"dddd, D MMMM [năm] YYYY HH:mm",l:"DD/M/YYYY",ll:"D MMM YYYY",lll:"D MMM YYYY HH:mm",llll:"ddd, D MMM YYYY HH:mm"},relativeTime:{future:"%s tới",past:"%s trước",s:"vài giây",m:"một phút",mm:"%d phút",h:"một giờ",hh:"%d giờ",d:"một ngày",dd:"%d ngày",M:"một tháng",MM:"%d tháng",y:"một năm",yy:"%d năm"}};return s.default.locale(o,null,!0),o})})(ve);var V={exports:{}};(function(e,t){(function(n,r){e.exports=r()})(A,function(){return function(n,r,s){n=n||{};var o=r.prototype,a={future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"};function c(i,l,f,I){return o.fromToBase(i,l,f,I)}s.en.relativeTime=a,o.fromToBase=function(i,l,f,I,O){for(var b,S,E,M=f.$locale().relativeTime||a,D=n.thresholds||[{l:"s",r:44,d:"second"},{l:"m",r:89},{l:"mm",r:44,d:"minute"},{l:"h",r:89},{l:"hh",r:21,d:"hour"},{l:"d",r:35},{l:"dd",r:25,d:"day"},{l:"M",r:45},{l:"MM",r:10,d:"month"},{l:"y",r:17},{l:"yy",d:"year"}],K=D.length,_=0;_<K;_+=1){var w=D[_];w.d&&(b=I?s(i).diff(f,w.d,!0):f.diff(i,w.d,!0));var v=(n.rounding||Math.round)(Math.abs(b));if(E=b>0,v<=w.r||!w.r){v<=1&&_>0&&(w=D[_-1]);var k=M[w.l];O&&(v=O(""+v)),S=typeof k=="string"?k.replace("%d",v):k(v,l,w.l,E);break}}if(l)return S;var C=E?M.future:M.past;return typeof C=="function"?C(S):C.replace("%s",S)},o.to=function(i,l){return c(i,l,this,!0)},o.from=function(i,l){return c(i,l,this)};var d=function(i){return i.$u?s.utc():s()};o.toNow=function(i){return this.to(d(this),i)},o.fromNow=function(i){return this.from(d(this),i)}}})})(V);var _e=V.exports;const Ee=q(_e);export{ye as a,be as c,Ee as r};
