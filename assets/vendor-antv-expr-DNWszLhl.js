const e={abs:Math.abs,ceil:Math.ceil,floor:Math.floor,max:Math.max,min:Math.min,round:Math.round,sqrt:Math.sqrt,pow:Math.pow};class t extends Error{constructor(e,t,n){super(e),this.position=t,this.token=n,this.name="ExpressionError"}}var n,r;(r=n||(n={}))[r.STRING=0]="STRING",r[r.NUMBER=1]="NUMBER",r[r.BOOLEAN=2]="BOOLEAN",r[r.NULL=3]="NULL",r[r.IDENTIFIER=4]="IDENTIFIER",r[r.OPERATOR=5]="OPERATOR",r[r.FUNCTION=6]="FUNCTION",r[r.DOT=7]="DOT",r[r.BRACKET_LEFT=8]="BRACKET_LEFT",r[r.BRACKET_RIGHT=9]="BRACKET_RIGHT",r[r.PAREN_LEFT=10]="PAREN_LEFT",r[r.PAREN_RIGHT=11]="PAREN_RIGHT",r[r.COMMA=12]="COMMA",r[r.QUESTION=13]="QUESTION",r[r.COLON=14]="COLON",r[r.DOLLAR=15]="DOLLAR";const o=new Set([32,9,10,13]),a=new Set([43,45,42,47,37,33,38,124,61,60,62]),s=new Map([["true",n.BOOLEAN],["false",n.BOOLEAN],["null",n.NULL]]),i=new Map([["===",!0],["!==",!0],["<=",!0],[">=",!0],["&&",!0],["||",!0],["+",!0],["-",!0],["*",!0],["/",!0],["%",!0],["!",!0],["<",!0],[">",!0]]),u=new Map([[46,n.DOT],[91,n.BRACKET_LEFT],[93,n.BRACKET_RIGHT],[40,n.PAREN_LEFT],[41,n.PAREN_RIGHT],[44,n.COMMA],[63,n.QUESTION],[58,n.COLON],[36,n.DOLLAR]]),c=new Map;for(const[O,A]of u.entries())c.set(O,{type:A,value:String.fromCharCode(O)});function p(e){return e>=48&&e<=57}function l(e){return e>=97&&e<=122||e>=65&&e<=90||95===e}function f(e){return l(e)||p(e)}function E(e){return a.has(e)}var h;!function(e){e[e.Program=0]="Program",e[e.Literal=1]="Literal",e[e.Identifier=2]="Identifier",e[e.MemberExpression=3]="MemberExpression",e[e.CallExpression=4]="CallExpression",e[e.BinaryExpression=5]="BinaryExpression",e[e.UnaryExpression=6]="UnaryExpression",e[e.ConditionalExpression=7]="ConditionalExpression"}(h||(h={}));const d=new Map([["||",2],["&&",3],["===",4],["!==",4],[">",5],[">=",5],["<",5],["<=",5],["+",6],["-",6],["*",7],["/",7],["%",7],["!",8]]),R={type:h.Literal,value:null},T={type:h.Literal,value:!0},w={type:h.Literal,value:!1};function y(r){const a=(e=>{const r=e,a=r.length,u=new Array(Math.ceil(a/3));let h=0,d=0;function R(e){const o=d+1;d++;let s="",i=!1;for(;d<a;){const t=r.charCodeAt(d);if(t===e)return i||(s=r.substring(o,d)),d++,{type:n.STRING,value:s};92===t?(i||(s=r.substring(o,d),i=!0),d++,s+=r[d]):i&&(s+=r[d]),d++}throw new t(`Unterminated string starting with ${String.fromCharCode(e)}`,d,r.substring(Math.max(0,d-10),d))}function T(){const e=d;for(45===r.charCodeAt(d)&&d++;d<a&&p(r.charCodeAt(d));)d++;if(d<a&&46===r.charCodeAt(d))for(d++;d<a&&p(r.charCodeAt(d));)d++;const t=r.slice(e,d);return{type:n.NUMBER,value:t}}function w(){d++;const e=d;if(d<a&&l(r.charCodeAt(d)))for(d++;d<a&&f(r.charCodeAt(d));)d++;const t=r.slice(e,d);return{type:n.FUNCTION,value:t}}function y(){const e=d++;for(;d<a&&f(r.charCodeAt(d));)d++;const t=r.slice(e,d),o=s.get(t);return o?{type:o,value:t}:{type:n.IDENTIFIER,value:t}}function O(){if(d+2<a){const e=r.substring(d,d+3);if(i.has(e))return d+=3,{type:n.OPERATOR,value:e}}if(d+1<a){const e=r.substring(d,d+2);if(i.has(e))return d+=2,{type:n.OPERATOR,value:e}}const e=r[d];if(i.has(e))return d++,{type:n.OPERATOR,value:e};throw new t(`Unknown operator at position ${d}: ${r.substring(d,d+1)}`,d,r.substring(Math.max(0,d-10),d))}for(;d<a;){const e=r.charCodeAt(d);if(A=e,o.has(A)){d++;continue}const n=c.get(e);if(n)u[h++]=n,d++;else if(34!==e&&39!==e)if(p(e)||45===e&&d+1<a&&p(r.charCodeAt(d+1)))u[h++]=T();else if(64!==e)if(l(e))u[h++]=y();else{if(!E(e))throw new t(`Unexpected character: ${r[d]}`,d,r.substring(Math.max(0,d-10),d));u[h++]=O()}else u[h++]=w();else u[h++]=R(e)}var A;return h===u.length?u:u.slice(0,h)})(r),u=(e=>{let r=0;const o=e.length,a=()=>r>=o?null:e[r],s=()=>e[r++],i=e=>{const t=a();return null!==t&&t.type===e},u=e=>e.type===n.OPERATOR?d.get(e.value)||-1:e.type===n.DOT||e.type===n.BRACKET_LEFT?9:e.type===n.QUESTION?1:-1,c=e=>{let o,u;if(s().type===n.DOT){if(!i(n.IDENTIFIER)){const e=a();throw new t("Expected property name",r,e?e.value:"<end of input>")}const e=s();o={type:h.Identifier,name:e.value},u=!1}else{if(o=l(0),!i(n.BRACKET_RIGHT)){const e=a();throw new t("Expected closing bracket",r,e?e.value:"<end of input>")}s(),u=!0}return{type:h.MemberExpression,object:e,property:o,computed:u}},p=()=>{const e=a();if(!e)throw new t("Unexpected end of input",r,"<end of input>");if(e.type===n.OPERATOR&&("!"===e.value||"-"===e.value)){s();const t=p();return{type:h.UnaryExpression,operator:e.value,argument:t,prefix:!0}}switch(e.type){case n.NUMBER:return s(),{type:h.Literal,value:Number(e.value)};case n.STRING:return s(),{type:h.Literal,value:e.value};case n.BOOLEAN:return s(),"true"===e.value?T:w;case n.NULL:return s(),R;case n.IDENTIFIER:return s(),{type:h.Identifier,name:e.value};case n.FUNCTION:return(()=>{const e=s(),o=[];if(!i(n.PAREN_LEFT)){const e=a();throw new t("Expected opening parenthesis after function name",r,e?e.value:"<end of input>")}for(s();;){if(i(n.PAREN_RIGHT)){s();break}if(!a()){const e=a();throw new t("Expected closing parenthesis",r,e?e.value:"<end of input>")}if(o.length>0){if(!i(n.COMMA)){const e=a();throw new t("Expected comma between function arguments",r,e?e.value:"<end of input>")}s()}const e=l(0);o.push(e)}return{type:h.CallExpression,callee:{type:h.Identifier,name:e.value},arguments:o}})();case n.PAREN_LEFT:{s();const e=l(0);if(!i(n.PAREN_RIGHT)){const e=a();throw new t("Expected closing parenthesis",r,e?e.value:"<end of input>")}return s(),e}default:throw new t(`Unexpected token: ${e.type}`,r,e.value)}},l=(f=0)=>{let E=p();for(;r<o;){const o=e[r],p=u(o);if(p<=f)break;if(o.type!==n.QUESTION)if(o.type!==n.OPERATOR){if(o.type!==n.DOT&&o.type!==n.BRACKET_LEFT)break;E=c(E)}else{s();const e=l(p);E={type:h.BinaryExpression,operator:o.value,left:E,right:e}}else{s();const e=l(0);if(!i(n.COLON)){const e=a();throw new t("Expected : in conditional expression",r,e?e.value:"<end of input>")}s();const o=l(0);E={type:h.ConditionalExpression,test:E,consequent:e,alternate:o}}}return E},f=l();return{type:h.Program,body:f}})(a),y=((e={},t={})=>({context:e,functions:t}))({},e);return(e={})=>((e,n,r)=>{let o=n;r&&(o={...n,context:{...n.context,...r}});const a=e=>{switch(e.type){case h.Literal:return e.value;case h.Identifier:return(e=>{if(!(e.name in o.context))throw new t(`Undefined variable: ${e.name}`);return o.context[e.name]})(e);case h.MemberExpression:return(e=>{const n=a(e.object);if(null==n)throw new t("Cannot access property of null or undefined");return n[e.computed?a(e.property):e.property.name]})(e);case h.CallExpression:return(e=>{const n=o.functions[e.callee.name];if(!n)throw new t(`Undefined function: ${e.callee.name}`);return n(...e.arguments.map(e=>a(e)))})(e);case h.BinaryExpression:return(e=>{if("&&"===e.operator){const t=a(e.left);return t?a(e.right):t}if("||"===e.operator)return a(e.left)||a(e.right);const n=a(e.left),r=a(e.right);switch(e.operator){case"+":return n+r;case"-":return n-r;case"*":return n*r;case"/":return n/r;case"%":return n%r;case"===":return n===r;case"!==":return n!==r;case">":return n>r;case">=":return n>=r;case"<":return n<r;case"<=":return n<=r;default:throw new t(`Unknown operator: ${e.operator}`)}})(e);case h.UnaryExpression:return(e=>{const n=a(e.argument);if(e.prefix)switch(e.operator){case"!":return!n;case"-":if("number"!=typeof n)throw new t(`Cannot apply unary - to non-number: ${n}`);return-n;default:throw new t(`Unknown operator: ${e.operator}`)}throw new t(`Postfix operators are not supported: ${e.operator}`)})(e);case h.ConditionalExpression:return(e=>{const t=a(e.test);return a(t?e.consequent:e.alternate)})(e);default:throw new t(`Evaluation error: Unsupported node type: ${e.type}`)}};return a(e.body)})(u,y,e)}export{y as A};
