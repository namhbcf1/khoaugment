import{a as Q}from"./utils-Db1EesZb.js";import{_ as q,m as p}from"./index-D0cJwDsb.js";import{e as F,g as X}from"./vendor-DD54NZMZ.js";import{bO as G}from"./antd-pmzi8FkM.js";const N="auth_token",O="refresh_token",H="user_info",U="token_expiry",Z=(e,t,r=3600)=>{localStorage.setItem(N,e),localStorage.setItem(O,t);const n=Date.now()+r*1e3;localStorage.setItem(U,n.toString())},ee=()=>localStorage.getItem(N),te=()=>localStorage.getItem(O),$=()=>{localStorage.removeItem(N),localStorage.removeItem(O),localStorage.removeItem(H),localStorage.removeItem(U)},re=async()=>{const e=te();if(!e)return null;try{const{apiClient:t}=await q(async()=>{const{apiClient:n}=await Promise.resolve().then(()=>_e);return{apiClient:n}},void 0),r=await t.post("/auth/refresh",{refreshToken:e},{headers:{"X-Skip-Auth":"true"}});return r.data&&r.data.accessToken?(Z(r.data.accessToken,r.data.refreshToken||e,r.data.expiresIn||3600),r.data.user&&ne(r.data.user),r.data.accessToken):null}catch(t){return console.error("Failed to refresh token:",t),$(),null}},ne=e=>{localStorage.setItem(H,JSON.stringify(e))};class se{constructor(){this.cache=new Map,this.ttls=new Map,this.cleanupInterval=setInterval(()=>this.cleanup(),60*1e3)}set(t,r,n=0){if(this.cache.set(t,r),n>0){const s=Date.now()+n*1e3;this.ttls.set(t,s)}else this.ttls.delete(t)}get(t){if(this.isExpired(t)){this.delete(t);return}return this.cache.get(t)}delete(t){this.cache.delete(t),this.ttls.delete(t)}clear(){this.cache.clear(),this.ttls.clear()}has(t){return this.cache.has(t)?this.isExpired(t)?(this.delete(t),!1):!0:!1}isExpired(t){const r=this.ttls.get(t);return r?Date.now()>r:!1}cleanup(){for(const[t,r]of this.ttls.entries())Date.now()>r&&this.delete(t)}keys(){return Array.from(this.cache.keys()).filter(t=>!this.isExpired(t))}destroy(){clearInterval(this.cleanupInterval),this.clear()}}const y=new se;class ae{constructor(t="posAppCache",r="cache",n=1){this.dbName=t,this.storeName=r,this.version=n,this.db=null,this.isInitialized=!1,this.init()}async init(){if(!window.indexedDB){console.warn("IndexedDB not supported");return}try{const t=indexedDB.open(this.dbName,this.version);t.onupgradeneeded=r=>{const n=r.target.result;n.objectStoreNames.contains(this.storeName)||n.createObjectStore(this.storeName,{keyPath:"key"}).createIndex("expiry","expiry",{unique:!1})},this.db=await new Promise((r,n)=>{t.onsuccess=s=>{r(s.target.result)},t.onerror=s=>{console.error("IndexedDB error:",s.target.error),n(s.target.error)}}),this.isInitialized=!0,this.scheduleCleanup()}catch(t){console.error("Failed to initialize IndexedDB cache:",t)}}async ensureInitialized(){return this.isInitialized?this.db:(await new Promise(t=>{const r=()=>{this.isInitialized?t():setTimeout(r,100)};r()}),this.db)}async set(t,r,n=0){try{const s=await this.ensureInitialized();if(!s)return;const o=n>0?Date.now()+n*1e3:0,a=s.transaction([this.storeName],"readwrite"),c=a.objectStore(this.storeName);await new Promise((d,i)=>{const l=c.put({key:t,value:r,expiry:o,created:Date.now()});l.onsuccess=()=>d(),l.onerror=f=>i(f.target.error),a.oncomplete=()=>d(),a.onerror=f=>i(f.target.error)})}catch(s){console.error("Failed to set item in IndexedDB cache:",s)}}async get(t){try{const r=await this.ensureInitialized();if(!r)return;const s=r.transaction([this.storeName],"readonly").objectStore(this.storeName);return await new Promise((a,c)=>{const d=s.get(t);d.onsuccess=i=>{const l=i.target.result;if(!l){a(void 0);return}l.expiry>0&&Date.now()>l.expiry?(this.delete(t).catch(console.error),a(void 0)):a(l.value)},d.onerror=i=>{console.error("Error getting cached item:",i.target.error),c(i.target.error)}})}catch(r){console.error("Failed to get item from IndexedDB cache:",r);return}}async delete(t){try{const r=await this.ensureInitialized();if(!r)return;const s=r.transaction([this.storeName],"readwrite").objectStore(this.storeName);await new Promise((o,a)=>{const c=s.delete(t);c.onsuccess=()=>o(),c.onerror=d=>a(d.target.error)})}catch(r){console.error("Failed to delete item from IndexedDB cache:",r)}}async clear(){try{const t=await this.ensureInitialized();if(!t)return;const n=t.transaction([this.storeName],"readwrite").objectStore(this.storeName);await new Promise((s,o)=>{const a=n.clear();a.onsuccess=()=>s(),a.onerror=c=>o(c.target.error)})}catch(t){console.error("Failed to clear IndexedDB cache:",t)}}async has(t){try{return await this.get(t)!==void 0}catch(r){return console.error("Failed to check key in IndexedDB cache:",r),!1}}async keys(){try{const t=await this.ensureInitialized();if(!t)return[];const n=t.transaction([this.storeName],"readonly").objectStore(this.storeName);return new Promise((s,o)=>{const a=n.getAllKeys();a.onsuccess=()=>s(a.result),a.onerror=c=>o(c.target.error)})}catch(t){return console.error("Failed to get keys from IndexedDB cache:",t),[]}}scheduleCleanup(){setInterval(()=>this.cleanup(),60*60*1e3)}async cleanup(){try{const t=await this.ensureInitialized();if(!t)return;const r=Date.now(),o=t.transaction([this.storeName],"readwrite").objectStore(this.storeName).index("expiry"),a=IDBKeyRange.bound(1,r);await new Promise((c,d)=>{const i=o.openCursor(a);i.onsuccess=l=>{const f=l.target.result;f?(f.delete(),f.continue()):c()},i.onerror=l=>d(l.target.error)}),console.log("IndexedDB cache cleanup completed")}catch(t){console.error("Failed to cleanup IndexedDB cache:",t)}}}const S=new ae,De={set:(e,t,r=0,n=!0)=>{y.set(e,t,r),n&&S.set(e,t,r).catch(console.error)},get:async e=>{const t=y.get(e);if(t!==void 0)return t;const r=await S.get(e);return r!==void 0&&y.set(e,r,0),r},delete:e=>{y.delete(e),S.delete(e).catch(console.error)},clear:()=>{y.clear(),S.clear().catch(console.error)},has:async e=>y.has(e)?!0:await S.has(e)},J={enabled:!0,consoleLog:!1,endpointUrl:"/api/analytics",bufferSize:10,flushInterval:3e4,samplingRate:1,includePerformance:!0,anonymizeIp:!0,offlineStorage:!0,appVersion:"1.0.0"};let h={...J},g=[],m={},z=!1,I=V(),R=0;const oe=(e={})=>{z||(h={...J,...e},ce(),h.flushInterval>0&&setInterval(()=>Y(),h.flushInterval),h.includePerformance&&le(),document.addEventListener("visibilitychange",de),window.addEventListener("online",ue),window.addEventListener("offline",he),ie(),z=!0)},w=(e,t={},r=!1)=>{if(!h.enabled||Math.random()>h.samplingRate)return;const n={eventName:e,eventData:t,timestamp:Date.now(),sessionId:I,url:window.location.href,referrer:document.referrer||"",userAgent:navigator.userAgent,screenSize:`${window.innerWidth}x${window.innerHeight}`,appVersion:h.appVersion};h.includePerformance&&(n.performance={...m}),h.consoleLog&&console.log(`Analytics Event: ${e}`,n),r?me(n):(g.push(n),g.length>=h.bufferSize&&Y())},ie=(e=null,t=null)=>{R++,w("page_view",{path:e||window.location.pathname,title:t||document.title,viewNumber:R})},Y=async()=>{if(!g.length)return!0;try{const e=[...g];return g=[],!navigator.onLine&&h.offlineStorage?(A(e),!1):(await L(e),!0)}catch(e){return console.error("Failed to flush analytics events:",e),h.offlineStorage?(A(g),g=[],!1):(g=[...g,...events],!1)}};function V(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function ce(){const e=sessionStorage.getItem("analytics_session_id"),t=parseInt(sessionStorage.getItem("analytics_session_timestamp")||"0"),r=Date.now();e&&r-t<30*60*1e3?I=e:(I=V(),sessionStorage.setItem("analytics_session_id",I)),sessionStorage.setItem("analytics_session_timestamp",r.toString())}function le(){try{const e=performance.getEntriesByType("navigation")[0],t=performance.getEntriesByType("paint");e&&(m.loadTime=e.loadEventEnd-e.startTime,m.domContentLoaded=e.domContentLoadedEventEnd-e.startTime,m.timeToFirstByte=e.responseStart-e.requestStart,m.domInteractive=e.domInteractive-e.startTime);const r=t.find(s=>s.name==="first-paint");r&&(m.firstPaint=r.startTime);const n=t.find(s=>s.name==="first-contentful-paint");if(n&&(m.firstContentfulPaint=n.startTime),performance.memory&&(m.jsHeapSizeLimit=performance.memory.jsHeapSizeLimit,m.totalJSHeapSize=performance.memory.totalJSHeapSize,m.usedJSHeapSize=performance.memory.usedJSHeapSize),w("performance",m),"PerformanceObserver"in window)try{new PerformanceObserver(o=>{o.getEntries().forEach(a=>{a.duration>50&&w("long_task",{duration:a.duration,name:a.name,startTime:a.startTime})})}).observe({entryTypes:["longtask"]})}catch(s){console.error("Long task tracking not supported:",s)}}catch(e){console.error("Error tracking performance:",e)}}function de(e){if(document.visibilityState==="hidden"){const t=Date.now()-m.pageVisibleTime;w("visibility_change",{state:"hidden",visibleTime:t},!0),Y()}else document.visibilityState==="visible"&&(m.pageVisibleTime=Date.now(),w("visibility_change",{state:"visible"}))}function ue(){fe(),w("connectivity_change",{state:"online"})}function he(){w("connectivity_change",{state:"offline"},!0)}function A(e){if(e.length)try{const n=[...JSON.parse(localStorage.getItem("offline_analytics_events")||"[]"),...e].slice(-100);localStorage.setItem("offline_analytics_events",JSON.stringify(n))}catch(t){console.error("Failed to store offline events:",t)}}async function fe(){try{const e=JSON.parse(localStorage.getItem("offline_analytics_events")||"[]");if(e.length===0)return;localStorage.removeItem("offline_analytics_events"),await L(e)}catch(e){console.error("Failed to process offline events:",e)}}async function me(e){await L([e])}async function L(e){if(!(!e.length||!h.endpointUrl))try{if(navigator.sendBeacon){const t=new Blob([JSON.stringify({events:e})],{type:"application/json"});if(navigator.sendBeacon(h.endpointUrl,t))return}await fetch(h.endpointUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({events:e}),keepalive:!0})}catch(t){throw console.error("Failed to send analytics events:",t),t}}typeof window<"u"&&oe();const pe=15e3,j=1e3,u=Q.create({baseURL:"http://127.0.0.1:8787/api",timeout:pe,headers:{"Content-Type":"application/json","X-Client-Version":"1.0.0"}});u.interceptors.request.use(async e=>{if(e.url&&(e.url.includes("/auth/login")||e.url.includes("/auth/refresh")))return e;const t=ee();return t&&(e.headers.Authorization=`Bearer ${t}`),e.metadata={startTime:Date.now()},e.headers["X-Offline-Operation"]=navigator.onLine?"false":"true",e},e=>Promise.reject(e));u.interceptors.response.use(e=>{if(e.config.metadata){const t=Date.now()-e.config.metadata.startTime;e.duration=t,t>1e3&&(console.warn(`Slow API request: ${e.config.url} took ${t}ms`),w("api_performance",{endpoint:e.config.url,duration:t,status:e.status}))}return e},async e=>{const t=e.config;if(!e.response&&e.message==="Network Error"){await ge(t);const n=await ye(t);return n?Promise.resolve({...n,isOfflineCache:!0}):Promise.reject({...e,isOfflineError:!0,message:"You are currently offline. This operation will sync when you're back online."})}if(e.response&&e.response.status===401&&!t._retry){t._retry=!0;try{const n=await re();if(n)return t.headers.Authorization=`Bearer ${n}`,u(t)}catch(n){return $(),window.location.href="/login?session_expired=true",Promise.reject(n)}}if(e.response&&e.response.status===429&&!t._rateLimit){const n=e.response.headers["retry-after"]?parseInt(e.response.headers["retry-after"])*1e3:j;return t._rateLimit=!0,await new Promise(s=>setTimeout(s,n)),u(t)}if(e.response&&e.response.status>=500&&!t._serverRetry)return t._serverRetry=!0,await new Promise(n=>setTimeout(n,j)),u(t);const r={status:e.response?e.response.status:0,message:e.response&&e.response.data.message||e.message,data:e.response?e.response.data:null,originalError:e};return w("api_error",{endpoint:t.url,method:t.method,status:r.status,message:r.message}),Promise.reject(r)});async function ge(e){if(!("serviceWorker"in navigator)||!navigator.serviceWorker.controller){const t=JSON.parse(localStorage.getItem("offlineApiQueue")||"[]");t.push({url:e.url,method:e.method,data:e.data,headers:e.headers,timestamp:Date.now()}),localStorage.setItem("offlineApiQueue",JSON.stringify(t));return}try{await navigator.serviceWorker.ready,await navigator.serviceWorker.controller.postMessage({type:"ENQUEUE_REQUEST",payload:{url:e.url,method:e.method,data:e.data,headers:e.headers,timestamp:Date.now()}})}catch(t){console.error("Failed to queue offline request:",t)}}async function ye(e){const t=`api_cache_${e.url}_${JSON.stringify(e.params||{})}`,r=y.get(t);if(r)return r;if("serviceWorker"in navigator&&navigator.serviceWorker.controller)try{await navigator.serviceWorker.ready;const n=await new Promise(s=>{const o=new MessageChannel;o.port1.onmessage=a=>s(a.data),navigator.serviceWorker.controller.postMessage({type:"GET_CACHED_RESPONSE",payload:{url:e.url,params:e.params}},[o.port2])});if(n&&n.data)return n.data}catch(n){console.error("Failed to get cached response:",n)}return null}const we={async get(e,t={}){return(await u.get(e,t)).data},async post(e,t={},r={}){return(await u.post(e,t,r)).data},async put(e,t={},r={}){return(await u.put(e,t,r)).data},async patch(e,t={},r={}){return(await u.patch(e,t,r)).data},async delete(e,t={}){return(await u.delete(e,t)).data},async getCached(e,t={},r=300){const n=`api_cache_${e}_${JSON.stringify(t.params||{})}`,s=y.get(n);if(s)return s;const o=await u.get(e,t);return y.set(n,o.data,r),o.data},async upload(e,t,r=null,n={}){const s={...n,headers:{...n.headers,"Content-Type":"multipart/form-data"}};return r&&(s.onUploadProgress=a=>{const c=Math.round(a.loaded*100/a.total);r(c,a)}),(await u.post(e,t,s)).data},async download(e,t={},r=null,n=null){const s={params:t,responseType:"blob",headers:{Accept:"application/octet-stream"}};n&&(s.onDownloadProgress=a=>{const c=Math.round(a.loaded*100/a.total);n(c,a)});const o=await u.get(e,s);if(r){const a=new Blob([o.data]),c=window.URL.createObjectURL(a),d=document.createElement("a");d.href=c,d.download=r,document.body.appendChild(d),d.click(),d.remove(),window.URL.revokeObjectURL(c)}return o.data},async batch(e){return(await Promise.allSettled(e.map(r=>{const n=(r.method||"get").toLowerCase();return u[n](r.url,r.data,r.config)}))).map(r=>r.status==="fulfilled"?{success:!0,data:r.value.data}:{success:!1,error:{status:r.reason.response?.status,message:r.reason.response?.data?.message||r.reason.message}})},async healthCheck(){try{return(await u.get("/health",{timeout:5e3})).status===200}catch{return!1}},getClient(){return u}};window.addEventListener("online",async()=>{const e=JSON.parse(localStorage.getItem("offlineApiQueue")||"[]");if(e.length>0){console.log(`Processing ${e.length} offline requests`);for(const t of e)try{await u({url:t.url,method:t.method,data:t.data,headers:t.headers})}catch(r){console.error("Failed to process offline request:",r)}localStorage.removeItem("offlineApiQueue")}console.log("Back online. Synced offline changes.")});window.addEventListener("offline",()=>{console.log("You are offline. Changes will be saved and synced when you reconnect.")});const ve={...we,async login(e,t){return await p.login(e,t)},async logout(){return await p.logout()},async getProfile(){return await p.getProfile()},async getProducts(e={}){return await p.getProducts(e)},async getProduct(e){return await p.getProduct(e)},async getOrders(e={}){return await p.getOrders(e)},async createOrder(e){return await p.createOrder(e)},async getDashboardStats(){return await p.getDashboardStats()},async getCategories(){return await p.getCategories()}},_e=Object.freeze(Object.defineProperty({__proto__:null,api:ve,apiClient:u},Symbol.toStringTag,{value:"Module"}));var Te={exports:{}};(function(e,t){(function(r,n){e.exports=n(G)})(F,function(r){function n(a){return a&&typeof a=="object"&&"default"in a?a:{default:a}}var s=n(r),o={name:"vi",weekdays:"chủ nhật_thứ hai_thứ ba_thứ tư_thứ năm_thứ sáu_thứ bảy".split("_"),months:"tháng 1_tháng 2_tháng 3_tháng 4_tháng 5_tháng 6_tháng 7_tháng 8_tháng 9_tháng 10_tháng 11_tháng 12".split("_"),weekStart:1,weekdaysShort:"CN_T2_T3_T4_T5_T6_T7".split("_"),monthsShort:"Th01_Th02_Th03_Th04_Th05_Th06_Th07_Th08_Th09_Th10_Th11_Th12".split("_"),weekdaysMin:"CN_T2_T3_T4_T5_T6_T7".split("_"),ordinal:function(a){return a},formats:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM [năm] YYYY",LLL:"D MMMM [năm] YYYY HH:mm",LLLL:"dddd, D MMMM [năm] YYYY HH:mm",l:"DD/M/YYYY",ll:"D MMM YYYY",lll:"D MMM YYYY HH:mm",llll:"ddd, D MMM YYYY HH:mm"},relativeTime:{future:"%s tới",past:"%s trước",s:"vài giây",m:"một phút",mm:"%d phút",h:"một giờ",hh:"%d giờ",d:"một ngày",dd:"%d ngày",M:"một tháng",MM:"%d tháng",y:"một năm",yy:"%d năm"}};return s.default.locale(o,null,!0),o})})(Te);var K={exports:{}};(function(e,t){(function(r,n){e.exports=n()})(F,function(){return function(r,n,s){r=r||{};var o=n.prototype,a={future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"};function c(i,l,f,b){return o.fromToBase(i,l,f,b)}s.en.relativeTime=a,o.fromToBase=function(i,l,f,b,B){for(var E,x,D,M=f.$locale().relativeTime||a,k=r.thresholds||[{l:"s",r:44,d:"second"},{l:"m",r:89},{l:"mm",r:44,d:"minute"},{l:"h",r:89},{l:"hh",r:21,d:"hour"},{l:"d",r:35},{l:"dd",r:25,d:"day"},{l:"M",r:45},{l:"MM",r:10,d:"month"},{l:"y",r:17},{l:"yy",d:"year"}],W=k.length,T=0;T<W;T+=1){var v=k[T];v.d&&(E=b?s(i).diff(f,v.d,!0):f.diff(i,v.d,!0));var _=(r.rounding||Math.round)(Math.abs(E));if(D=E>0,_<=v.r||!v.r){_<=1&&T>0&&(v=k[T-1]);var C=M[v.l];B&&(_=B(""+_)),x=typeof C=="string"?C.replace("%d",_):C(_,l,v.l,D);break}}if(l)return x;var P=D?M.future:M.past;return typeof P=="function"?P(x):P.replace("%s",x)},o.to=function(i,l){return c(i,l,this,!0)},o.from=function(i,l){return c(i,l,this)};var d=function(i){return i.$u?s.utc():s()};o.toNow=function(i){return this.to(d(this),i)},o.fromNow=function(i){return this.from(d(this),i)}}})})(K);var Se=K.exports;const Me=X(Se);export{De as c,ve as e,Me as r};
