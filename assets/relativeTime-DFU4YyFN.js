import{a as q}from"./utils-Db1EesZb.js";import{_ as X,s as p,m as g}from"./index-CI5lv9mG.js";import{e as H,g as G}from"./vendor-DD54NZMZ.js";import{bO as Z}from"./antd-pmzi8FkM.js";const O="auth_token",Y="refresh_token",U="user_info",$="token_expiry",ee=(e,t,r=3600)=>{localStorage.setItem(O,e),localStorage.setItem(Y,t);const n=Date.now()+r*1e3;localStorage.setItem($,n.toString())},te=()=>localStorage.getItem(O),re=()=>localStorage.getItem(Y),J=()=>{localStorage.removeItem(O),localStorage.removeItem(Y),localStorage.removeItem(U),localStorage.removeItem($)},ne=async()=>{const e=re();if(!e)return null;try{const{apiClient:t}=await X(async()=>{const{apiClient:n}=await Promise.resolve().then(()=>Te);return{apiClient:n}},void 0),r=await t.post("/auth/refresh",{refreshToken:e},{headers:{"X-Skip-Auth":"true"}});return r.data&&r.data.accessToken?(ee(r.data.accessToken,r.data.refreshToken||e,r.data.expiresIn||3600),r.data.user&&se(r.data.user),r.data.accessToken):null}catch(t){return console.error("Failed to refresh token:",t),J(),null}},se=e=>{localStorage.setItem(U,JSON.stringify(e))};class ae{constructor(){this.cache=new Map,this.ttls=new Map,this.cleanupInterval=setInterval(()=>this.cleanup(),60*1e3)}set(t,r,n=0){if(this.cache.set(t,r),n>0){const s=Date.now()+n*1e3;this.ttls.set(t,s)}else this.ttls.delete(t)}get(t){if(this.isExpired(t)){this.delete(t);return}return this.cache.get(t)}delete(t){this.cache.delete(t),this.ttls.delete(t)}clear(){this.cache.clear(),this.ttls.clear()}has(t){return this.cache.has(t)?this.isExpired(t)?(this.delete(t),!1):!0:!1}isExpired(t){const r=this.ttls.get(t);return r?Date.now()>r:!1}cleanup(){for(const[t,r]of this.ttls.entries())Date.now()>r&&this.delete(t)}keys(){return Array.from(this.cache.keys()).filter(t=>!this.isExpired(t))}destroy(){clearInterval(this.cleanupInterval),this.clear()}}const w=new ae;class oe{constructor(t="posAppCache",r="cache",n=1){this.dbName=t,this.storeName=r,this.version=n,this.db=null,this.isInitialized=!1,this.init()}async init(){if(!window.indexedDB){console.warn("IndexedDB not supported");return}try{const t=indexedDB.open(this.dbName,this.version);t.onupgradeneeded=r=>{const n=r.target.result;n.objectStoreNames.contains(this.storeName)||n.createObjectStore(this.storeName,{keyPath:"key"}).createIndex("expiry","expiry",{unique:!1})},this.db=await new Promise((r,n)=>{t.onsuccess=s=>{r(s.target.result)},t.onerror=s=>{console.error("IndexedDB error:",s.target.error),n(s.target.error)}}),this.isInitialized=!0,this.scheduleCleanup()}catch(t){console.error("Failed to initialize IndexedDB cache:",t)}}async ensureInitialized(){return this.isInitialized?this.db:(await new Promise(t=>{const r=()=>{this.isInitialized?t():setTimeout(r,100)};r()}),this.db)}async set(t,r,n=0){try{const s=await this.ensureInitialized();if(!s)return;const o=n>0?Date.now()+n*1e3:0,a=s.transaction([this.storeName],"readwrite"),c=a.objectStore(this.storeName);await new Promise((d,i)=>{const l=c.put({key:t,value:r,expiry:o,created:Date.now()});l.onsuccess=()=>d(),l.onerror=h=>i(h.target.error),a.oncomplete=()=>d(),a.onerror=h=>i(h.target.error)})}catch(s){console.error("Failed to set item in IndexedDB cache:",s)}}async get(t){try{const r=await this.ensureInitialized();if(!r)return;const s=r.transaction([this.storeName],"readonly").objectStore(this.storeName);return await new Promise((a,c)=>{const d=s.get(t);d.onsuccess=i=>{const l=i.target.result;if(!l){a(void 0);return}l.expiry>0&&Date.now()>l.expiry?(this.delete(t).catch(console.error),a(void 0)):a(l.value)},d.onerror=i=>{console.error("Error getting cached item:",i.target.error),c(i.target.error)}})}catch(r){console.error("Failed to get item from IndexedDB cache:",r);return}}async delete(t){try{const r=await this.ensureInitialized();if(!r)return;const s=r.transaction([this.storeName],"readwrite").objectStore(this.storeName);await new Promise((o,a)=>{const c=s.delete(t);c.onsuccess=()=>o(),c.onerror=d=>a(d.target.error)})}catch(r){console.error("Failed to delete item from IndexedDB cache:",r)}}async clear(){try{const t=await this.ensureInitialized();if(!t)return;const n=t.transaction([this.storeName],"readwrite").objectStore(this.storeName);await new Promise((s,o)=>{const a=n.clear();a.onsuccess=()=>s(),a.onerror=c=>o(c.target.error)})}catch(t){console.error("Failed to clear IndexedDB cache:",t)}}async has(t){try{return await this.get(t)!==void 0}catch(r){return console.error("Failed to check key in IndexedDB cache:",r),!1}}async keys(){try{const t=await this.ensureInitialized();if(!t)return[];const n=t.transaction([this.storeName],"readonly").objectStore(this.storeName);return new Promise((s,o)=>{const a=n.getAllKeys();a.onsuccess=()=>s(a.result),a.onerror=c=>o(c.target.error)})}catch(t){return console.error("Failed to get keys from IndexedDB cache:",t),[]}}scheduleCleanup(){setInterval(()=>this.cleanup(),60*60*1e3)}async cleanup(){try{const t=await this.ensureInitialized();if(!t)return;const r=Date.now(),o=t.transaction([this.storeName],"readwrite").objectStore(this.storeName).index("expiry"),a=IDBKeyRange.bound(1,r);await new Promise((c,d)=>{const i=o.openCursor(a);i.onsuccess=l=>{const h=l.target.result;h?(h.delete(),h.continue()):c()},i.onerror=l=>d(l.target.error)}),console.log("IndexedDB cache cleanup completed")}catch(t){console.error("Failed to cleanup IndexedDB cache:",t)}}}const x=new oe,De={set:(e,t,r=0,n=!0)=>{w.set(e,t,r),n&&x.set(e,t,r).catch(console.error)},get:async e=>{const t=w.get(e);if(t!==void 0)return t;const r=await x.get(e);return r!==void 0&&w.set(e,r,0),r},delete:e=>{w.delete(e),x.delete(e).catch(console.error)},clear:()=>{w.clear(),x.clear().catch(console.error)},has:async e=>w.has(e)?!0:await x.has(e)},V={enabled:!0,consoleLog:!1,endpointUrl:"/api/analytics",bufferSize:10,flushInterval:3e4,samplingRate:1,includePerformance:!0,anonymizeIp:!0,offlineStorage:!0,appVersion:"1.0.0"};let f={...V},y=[],m={},A=!1,b=K(),R=0;const ie=(e={})=>{A||(f={...V,...e},le(),f.flushInterval>0&&setInterval(()=>L(),f.flushInterval),f.includePerformance&&de(),document.addEventListener("visibilitychange",ue),window.addEventListener("online",fe),window.addEventListener("offline",he),ce(),A=!0)},v=(e,t={},r=!1)=>{if(!f.enabled||Math.random()>f.samplingRate)return;const n={eventName:e,eventData:t,timestamp:Date.now(),sessionId:b,url:window.location.href,referrer:document.referrer||"",userAgent:navigator.userAgent,screenSize:`${window.innerWidth}x${window.innerHeight}`,appVersion:f.appVersion};f.includePerformance&&(n.performance={...m}),f.consoleLog&&console.log(`Analytics Event: ${e}`,n),r?pe(n):(y.push(n),y.length>=f.bufferSize&&L())},ce=(e=null,t=null)=>{R++,v("page_view",{path:e||window.location.pathname,title:t||document.title,viewNumber:R})},L=async()=>{if(!y.length)return!0;try{const e=[...y];return y=[],!navigator.onLine&&f.offlineStorage?(j(e),!1):(await B(e),!0)}catch(e){return console.error("Failed to flush analytics events:",e),f.offlineStorage?(j(y),y=[],!1):(y=[...y,...events],!1)}};function K(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function le(){const e=sessionStorage.getItem("analytics_session_id"),t=parseInt(sessionStorage.getItem("analytics_session_timestamp")||"0"),r=Date.now();e&&r-t<30*60*1e3?b=e:(b=K(),sessionStorage.setItem("analytics_session_id",b)),sessionStorage.setItem("analytics_session_timestamp",r.toString())}function de(){try{const e=performance.getEntriesByType("navigation")[0],t=performance.getEntriesByType("paint");e&&(m.loadTime=e.loadEventEnd-e.startTime,m.domContentLoaded=e.domContentLoadedEventEnd-e.startTime,m.timeToFirstByte=e.responseStart-e.requestStart,m.domInteractive=e.domInteractive-e.startTime);const r=t.find(s=>s.name==="first-paint");r&&(m.firstPaint=r.startTime);const n=t.find(s=>s.name==="first-contentful-paint");if(n&&(m.firstContentfulPaint=n.startTime),performance.memory&&(m.jsHeapSizeLimit=performance.memory.jsHeapSizeLimit,m.totalJSHeapSize=performance.memory.totalJSHeapSize,m.usedJSHeapSize=performance.memory.usedJSHeapSize),v("performance",m),"PerformanceObserver"in window)try{new PerformanceObserver(o=>{o.getEntries().forEach(a=>{a.duration>50&&v("long_task",{duration:a.duration,name:a.name,startTime:a.startTime})})}).observe({entryTypes:["longtask"]})}catch(s){console.error("Long task tracking not supported:",s)}}catch(e){console.error("Error tracking performance:",e)}}function ue(e){if(document.visibilityState==="hidden"){const t=Date.now()-m.pageVisibleTime;v("visibility_change",{state:"hidden",visibleTime:t},!0),L()}else document.visibilityState==="visible"&&(m.pageVisibleTime=Date.now(),v("visibility_change",{state:"visible"}))}function fe(){me(),v("connectivity_change",{state:"online"})}function he(){v("connectivity_change",{state:"offline"},!0)}function j(e){if(e.length)try{const n=[...JSON.parse(localStorage.getItem("offline_analytics_events")||"[]"),...e].slice(-100);localStorage.setItem("offline_analytics_events",JSON.stringify(n))}catch(t){console.error("Failed to store offline events:",t)}}async function me(){try{const e=JSON.parse(localStorage.getItem("offline_analytics_events")||"[]");if(e.length===0)return;localStorage.removeItem("offline_analytics_events"),await B(e)}catch(e){console.error("Failed to process offline events:",e)}}async function pe(e){await B([e])}async function B(e){if(!(!e.length||!f.endpointUrl))try{if(navigator.sendBeacon){const t=new Blob([JSON.stringify({events:e})],{type:"application/json"});if(navigator.sendBeacon(f.endpointUrl,t))return}await fetch(f.endpointUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({events:e}),keepalive:!0})}catch(t){throw console.error("Failed to send analytics events:",t),t}}typeof window<"u"&&ie();const ge=15e3,F=1e3,u=q.create({baseURL:"http://127.0.0.1:8787/api",timeout:ge,headers:{"Content-Type":"application/json","X-Client-Version":"1.0.0"}});u.interceptors.request.use(async e=>{if(e.url&&(e.url.includes("/auth/login")||e.url.includes("/auth/refresh")))return e;const t=te();return t&&(e.headers.Authorization=`Bearer ${t}`),e.metadata={startTime:Date.now()},e.headers["X-Offline-Operation"]=navigator.onLine?"false":"true",e},e=>Promise.reject(e));u.interceptors.response.use(e=>{if(e.config.metadata){const t=Date.now()-e.config.metadata.startTime;e.duration=t,t>1e3&&(console.warn(`Slow API request: ${e.config.url} took ${t}ms`),v("api_performance",{endpoint:e.config.url,duration:t,status:e.status}))}return e},async e=>{const t=e.config;if(!e.response&&e.message==="Network Error"){await ye(t);const n=await we(t);return n?Promise.resolve({...n,isOfflineCache:!0}):Promise.reject({...e,isOfflineError:!0,message:"You are currently offline. This operation will sync when you're back online."})}if(e.response&&e.response.status===401&&!t._retry){t._retry=!0;try{const n=await ne();if(n)return t.headers.Authorization=`Bearer ${n}`,u(t)}catch(n){return J(),window.location.href="/login?session_expired=true",Promise.reject(n)}}if(e.response&&e.response.status===429&&!t._rateLimit){const n=e.response.headers["retry-after"]?parseInt(e.response.headers["retry-after"])*1e3:F;return t._rateLimit=!0,await new Promise(s=>setTimeout(s,n)),u(t)}if(e.response&&e.response.status>=500&&!t._serverRetry)return t._serverRetry=!0,await new Promise(n=>setTimeout(n,F)),u(t);const r={status:e.response?e.response.status:0,message:e.response&&e.response.data.message||e.message,data:e.response?e.response.data:null,originalError:e};return v("api_error",{endpoint:t.url,method:t.method,status:r.status,message:r.message}),Promise.reject(r)});async function ye(e){if(!("serviceWorker"in navigator)||!navigator.serviceWorker.controller){const t=JSON.parse(localStorage.getItem("offlineApiQueue")||"[]");t.push({url:e.url,method:e.method,data:e.data,headers:e.headers,timestamp:Date.now()}),localStorage.setItem("offlineApiQueue",JSON.stringify(t));return}try{await navigator.serviceWorker.ready,await navigator.serviceWorker.controller.postMessage({type:"ENQUEUE_REQUEST",payload:{url:e.url,method:e.method,data:e.data,headers:e.headers,timestamp:Date.now()}})}catch(t){console.error("Failed to queue offline request:",t)}}async function we(e){const t=`api_cache_${e.url}_${JSON.stringify(e.params||{})}`,r=w.get(t);if(r)return r;if("serviceWorker"in navigator&&navigator.serviceWorker.controller)try{await navigator.serviceWorker.ready;const n=await new Promise(s=>{const o=new MessageChannel;o.port1.onmessage=a=>s(a.data),navigator.serviceWorker.controller.postMessage({type:"GET_CACHED_RESPONSE",payload:{url:e.url,params:e.params}},[o.port2])});if(n&&n.data)return n.data}catch(n){console.error("Failed to get cached response:",n)}return null}const ve={async get(e,t={}){return(await u.get(e,t)).data},async post(e,t={},r={}){return(await u.post(e,t,r)).data},async put(e,t={},r={}){return(await u.put(e,t,r)).data},async patch(e,t={},r={}){return(await u.patch(e,t,r)).data},async delete(e,t={}){return(await u.delete(e,t)).data},async getCached(e,t={},r=300){const n=`api_cache_${e}_${JSON.stringify(t.params||{})}`,s=w.get(n);if(s)return s;const o=await u.get(e,t);return w.set(n,o.data,r),o.data},async upload(e,t,r=null,n={}){const s={...n,headers:{...n.headers,"Content-Type":"multipart/form-data"}};return r&&(s.onUploadProgress=a=>{const c=Math.round(a.loaded*100/a.total);r(c,a)}),(await u.post(e,t,s)).data},async download(e,t={},r=null,n=null){const s={params:t,responseType:"blob",headers:{Accept:"application/octet-stream"}};n&&(s.onDownloadProgress=a=>{const c=Math.round(a.loaded*100/a.total);n(c,a)});const o=await u.get(e,s);if(r){const a=new Blob([o.data]),c=window.URL.createObjectURL(a),d=document.createElement("a");d.href=c,d.download=r,document.body.appendChild(d),d.click(),d.remove(),window.URL.revokeObjectURL(c)}return o.data},async batch(e){return(await Promise.allSettled(e.map(r=>{const n=(r.method||"get").toLowerCase();return u[n](r.url,r.data,r.config)}))).map(r=>r.status==="fulfilled"?{success:!0,data:r.value.data}:{success:!1,error:{status:r.reason.response?.status,message:r.reason.response?.data?.message||r.reason.message}})},async healthCheck(){try{return(await u.get("/health",{timeout:5e3})).status===200}catch{return!1}},getClient(){return u}};window.addEventListener("online",async()=>{const e=JSON.parse(localStorage.getItem("offlineApiQueue")||"[]");if(e.length>0){console.log(`Processing ${e.length} offline requests`);for(const t of e)try{await u({url:t.url,method:t.method,data:t.data,headers:t.headers})}catch(r){console.error("Failed to process offline request:",r)}localStorage.removeItem("offlineApiQueue")}console.log("Back online. Synced offline changes.")});window.addEventListener("offline",()=>{console.log("You are offline. Changes will be saved and synced when you reconnect.")});const _e={...ve,async login(e,t){if(p())return await g.login(e,t)},async logout(){if(p())return await g.logout()},async getProfile(){if(p())return await g.getProfile()},async getProducts(e={}){if(p())return await g.getProducts(e)},async getProduct(e){if(p())return await g.getProduct(e)},async getOrders(e={}){if(p())return await g.getOrders(e)},async createOrder(e){if(p())return await g.createOrder(e)},async getDashboardStats(){if(p())return await g.getDashboardStats()},async getCategories(){if(p())return await g.getCategories()}},Te=Object.freeze(Object.defineProperty({__proto__:null,api:_e,apiClient:u},Symbol.toStringTag,{value:"Module"}));var Se={exports:{}};(function(e,t){(function(r,n){e.exports=n(Z)})(H,function(r){function n(a){return a&&typeof a=="object"&&"default"in a?a:{default:a}}var s=n(r),o={name:"vi",weekdays:"chủ nhật_thứ hai_thứ ba_thứ tư_thứ năm_thứ sáu_thứ bảy".split("_"),months:"tháng 1_tháng 2_tháng 3_tháng 4_tháng 5_tháng 6_tháng 7_tháng 8_tháng 9_tháng 10_tháng 11_tháng 12".split("_"),weekStart:1,weekdaysShort:"CN_T2_T3_T4_T5_T6_T7".split("_"),monthsShort:"Th01_Th02_Th03_Th04_Th05_Th06_Th07_Th08_Th09_Th10_Th11_Th12".split("_"),weekdaysMin:"CN_T2_T3_T4_T5_T6_T7".split("_"),ordinal:function(a){return a},formats:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM [năm] YYYY",LLL:"D MMMM [năm] YYYY HH:mm",LLLL:"dddd, D MMMM [năm] YYYY HH:mm",l:"DD/M/YYYY",ll:"D MMM YYYY",lll:"D MMM YYYY HH:mm",llll:"ddd, D MMM YYYY HH:mm"},relativeTime:{future:"%s tới",past:"%s trước",s:"vài giây",m:"một phút",mm:"%d phút",h:"một giờ",hh:"%d giờ",d:"một ngày",dd:"%d ngày",M:"một tháng",MM:"%d tháng",y:"một năm",yy:"%d năm"}};return s.default.locale(o,null,!0),o})})(Se);var W={exports:{}};(function(e,t){(function(r,n){e.exports=n()})(H,function(){return function(r,n,s){r=r||{};var o=n.prototype,a={future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"};function c(i,l,h,E){return o.fromToBase(i,l,h,E)}s.en.relativeTime=a,o.fromToBase=function(i,l,h,E,z){for(var M,I,D,k=h.$locale().relativeTime||a,C=r.thresholds||[{l:"s",r:44,d:"second"},{l:"m",r:89},{l:"mm",r:44,d:"minute"},{l:"h",r:89},{l:"hh",r:21,d:"hour"},{l:"d",r:35},{l:"dd",r:25,d:"day"},{l:"M",r:45},{l:"MM",r:10,d:"month"},{l:"y",r:17},{l:"yy",d:"year"}],Q=C.length,S=0;S<Q;S+=1){var _=C[S];_.d&&(M=E?s(i).diff(h,_.d,!0):h.diff(i,_.d,!0));var T=(r.rounding||Math.round)(Math.abs(M));if(D=M>0,T<=_.r||!_.r){T<=1&&S>0&&(_=C[S-1]);var P=k[_.l];z&&(T=z(""+T)),I=typeof P=="string"?P.replace("%d",T):P(T,l,_.l,D);break}}if(l)return I;var N=D?k.future:k.past;return typeof N=="function"?N(I):N.replace("%s",I)},o.to=function(i,l){return c(i,l,this,!0)},o.from=function(i,l){return c(i,l,this)};var d=function(i){return i.$u?s.utc():s()};o.toNow=function(i){return this.to(d(this),i)},o.fromNow=function(i){return this.from(d(this),i)}}})})(W);var xe=W.exports;const ke=G(xe);export{De as c,_e as e,ke as r};
